<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scenario Planning Tool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #000;
    --white: #fff;
    --accent: #7877f6;
    --blue: #0000FF;
    --lime: #daf13e;
    --gray: #e5e5e5;
    --gray-dark: #888;
    --gray-light: #f5f5f5;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Space Grotesk', sans-serif;
    font-weight: 300;
    background: var(--white);
    color: var(--black);
    min-height: 100dvh;
    display: flex;
    justify-content: center;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  /* Background gradient circles */
  .bg-circles {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none; z-index: 0; overflow: hidden;
  }
  .bg-circle {
    position: absolute; border-radius: 50%;
  }
  .bg-circle-1 {
    width: 500px; height: 500px; top: -150px; right: -120px;
    background: radial-gradient(circle, transparent 40%, rgba(0,0,255,0.08) 60%, rgba(0,0,255,0.15) 70%, transparent 80%);
  }
  .bg-circle-2 {
    width: 400px; height: 400px; bottom: -100px; left: -100px;
    background: radial-gradient(circle, transparent 35%, rgba(218,241,62,0.1) 55%, rgba(218,241,62,0.18) 65%, transparent 75%);
  }
  .bg-circle-3 {
    width: 300px; height: 300px; top: 40%; left: -80px;
    background: radial-gradient(circle, transparent 40%, rgba(0,0,255,0.05) 60%, rgba(0,0,255,0.1) 70%, transparent 80%);
  }
  /* Stronger circles for welcome/closing */
  .bg-circles.prominent .bg-circle-1 {
    background: radial-gradient(circle, transparent 30%, rgba(0,0,255,0.12) 50%, rgba(0,0,255,0.22) 65%, transparent 80%);
  }
  .bg-circles.prominent .bg-circle-2 {
    background: radial-gradient(circle, transparent 25%, rgba(218,241,62,0.15) 45%, rgba(218,241,62,0.25) 60%, transparent 75%);
  }
  .bg-circles.prominent .bg-circle-3 {
    background: radial-gradient(circle, transparent 30%, rgba(0,0,255,0.08) 50%, rgba(0,0,255,0.15) 65%, transparent 80%);
  }

  #app {
    width: 100%;
    max-width: 430px;
    min-height: 100dvh;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
  }

  h1, h2, h3 {
    font-family: 'Roboto Mono', monospace;
    font-weight: 400;
    letter-spacing: -0.02em;
  }
  h1 { font-size: 1.75rem; line-height: 1.2; }
  h2 { font-size: 1.25rem; line-height: 1.3; }
  h3 { font-size: 1rem; }
  p { line-height: 1.6; font-size: 0.95rem; }

  .screen { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.3s ease; }
  .screen.active { display: flex; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .spacer { flex: 1; }

  /* Buttons — rounded, dotted border */
  .btn {
    display: block; width: 100%; padding: 1rem;
    border: 1px dotted var(--black); border-radius: 2rem;
    background: var(--black); color: var(--white);
    font-family: 'Roboto Mono', monospace; font-size: 0.875rem; font-weight: 500;
    letter-spacing: 0.05em; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s ease; text-align: center;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .btn:hover { background: var(--white); color: var(--black); }
  .btn:active { transform: scale(0.98); }
  .btn-secondary { background: var(--white); color: var(--black); }
  .btn-secondary:hover { background: var(--black); color: var(--white); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn:disabled:hover { background: var(--black); color: var(--white); }
  .btn + .btn { margin-top: 0.75rem; }

  .subtitle {
    color: var(--gray-dark); font-size: 0.8rem;
    font-family: 'Roboto Mono', monospace;
    text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;
  }

  .session-code-display {
    font-family: 'Roboto Mono', monospace; font-size: 3rem; font-weight: 700;
    letter-spacing: 0.3em; text-align: center; padding: 2rem 0; color: var(--black);
  }

  input[type="text"], textarea {
    width: 100%; padding: 1rem; border: 1px solid var(--gray); border-radius: 1rem;
    font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 300;
    outline: none; transition: border-color 0.15s; background: var(--white);
  }
  input[type="text"]:focus, textarea:focus { border-color: var(--blue); }
  textarea { min-height: 100px; resize: vertical; line-height: 1.6; }

  /* Language toggle — rounded */
  .toggle-group { display: flex; border: 1px dotted var(--black); border-radius: 2rem; overflow: hidden; }
  .toggle-option {
    flex: 1; padding: 0.75rem; text-align: center;
    font-family: 'Roboto Mono', monospace; font-size: 0.8rem; font-weight: 500;
    cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.05em;
  }
  .toggle-option.active { background: var(--black); color: var(--white); }

  /* Statement toggle chips */
  .chip-group { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
  .chip {
    flex: 1; padding: 0.75rem 0.5rem; text-align: center;
    font-family: 'Roboto Mono', monospace; font-size: 0.75rem; font-weight: 500;
    cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.04em;
    border: 1px solid var(--gray); border-radius: 2rem; background: var(--white); color: var(--black);
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .chip.selected { background: var(--lime); color: var(--black); border-color: var(--lime); }

  /* Tech grid — choice chips */
  .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
  .tech-card {
    padding: 0.875rem; border: 1px solid var(--gray); border-radius: 2rem; text-align: center;
    font-family: 'Roboto Mono', monospace; font-size: 0.8rem; font-weight: 400;
    cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.05em;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .tech-card.selected { border-color: var(--blue); background: var(--blue); color: var(--white); }
  .tech-card.disabled { opacity: 0.3; cursor: not-allowed; }

  /* Choice tags on scenario screens */
  .choice-tags { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
  .choice-tag {
    font-family: 'Roboto Mono', monospace; font-size: 0.6rem; font-weight: 400;
    text-transform: uppercase; letter-spacing: 0.08em;
    padding: 0.2rem 0.5rem; border-radius: 1rem;
  }
  .choice-tag.tag-statement { background: var(--lime); color: var(--black); }
  .choice-tag.tag-tech { background: var(--blue); color: var(--white); }

  /* Scenario text — justified */
  .scenario-text { font-size: 1rem; line-height: 1.8; font-weight: 300; text-align: justify; }
  .scenario-text p { margin-bottom: 1em; }
  .scenario-text p:last-child { margin-bottom: 0; }
  .scenario-text .cursor, .weak-signals-content .cursor {
    display: inline-block; width: 2px; height: 1.1em; background: var(--blue);
    margin-left: 2px; animation: blink 0.8s infinite; vertical-align: text-bottom;
  }
  @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

  .timeframe {
    font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: var(--blue);
    text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 0.25rem;
  }
  .archetype-badge {
    display: inline-block; font-family: 'Roboto Mono', monospace; font-size: 0.7rem;
    text-transform: uppercase; letter-spacing: 0.1em;
    padding: 0.25rem 0.75rem; border: 1px solid var(--blue); color: var(--blue);
    border-radius: 1rem; margin-bottom: 1rem;
  }

  /* Weak signals */
  .weak-signals {
    margin-top: 2rem; padding: 1.25rem; border: 1px solid var(--gray);
    background: var(--gray-light); border-radius: 1rem;
  }
  .weak-signals-title {
    font-family: 'Roboto Mono', monospace; font-size: 0.7rem;
    text-transform: uppercase; letter-spacing: 0.15em; color: var(--blue); margin-bottom: 1rem;
  }
  .weak-signals-content { font-size: 0.875rem; line-height: 1.7; font-weight: 300; text-align: justify; }
  .weak-signals-content p { margin-bottom: 0.75em; }
  .weak-signals-content p:last-child { margin-bottom: 0; }

  /* Facilitation prompt */
  .facilitation {
    margin-top: 1.5rem; padding: 1rem; border-left: 3px solid var(--blue);
    background: var(--gray-light); font-size: 0.85rem; line-height: 1.6;
    color: var(--gray-dark); font-style: italic; border-radius: 0 0.5rem 0.5rem 0;
  }

  /* Loading */
  .loading {
    display: flex; align-items: center; gap: 0.75rem;
    font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: var(--gray-dark); padding: 2rem 0;
  }
  .loading .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--blue); animation: pulse 1.2s infinite; }
  .loading .dot:nth-child(2) { animation-delay: 0.2s; }
  .loading .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }

  /* Typing loader */
  .typing-loader {
    font-family: 'Roboto Mono', monospace; font-size: 0.9rem; color: var(--gray-dark);
    padding: 2rem 0; line-height: 1.6;
  }

  /* Toast notification */
  .toast {
    position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
    background: var(--black); color: var(--white); padding: 0.75rem 1.25rem;
    font-family: 'Roboto Mono', monospace; font-size: 0.75rem;
    border-radius: 2rem; z-index: 1000; display: none; text-align: center;
    max-width: 380px; width: 90%;
  }
  .toast.show { display: block; animation: fadeIn 0.3s ease; }
  .toast-btn {
    display: inline-block; margin-top: 0.5rem; padding: 0.3rem 0.75rem;
    border: 1px solid var(--white); color: var(--white); background: none;
    font-family: 'Roboto Mono', monospace; font-size: 0.7rem; cursor: pointer;
    text-transform: uppercase; letter-spacing: 0.05em; border-radius: 1rem;
  }
  .toast-btn:hover { background: var(--white); color: var(--black); }

  /* Bottom nav bar */
  .bottom-nav {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1rem 0; margin-top: 1.5rem;
    border-top: 1px solid var(--gray);
  }
  .nav-btn {
    font-family: 'Roboto Mono', monospace; font-size: 0.85rem; color: var(--gray-dark);
    cursor: pointer; padding: 0.75rem 1.25rem; border: 1px dotted var(--gray);
    background: none; text-transform: uppercase; letter-spacing: 0.05em;
    transition: all 0.15s; min-width: 100px; text-align: center; border-radius: 2rem;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .nav-btn:hover { border-color: var(--black); color: var(--black); }
  .nav-btn:active { background: var(--gray-light); }
  .nav-btn.hidden { visibility: hidden; }

  /* Char counter */
  .char-counter {
    font-family: 'Roboto Mono', monospace; font-size: 0.7rem; color: var(--gray-dark);
    text-align: right; margin-top: 0.25rem;
  }
  .char-counter.met { color: var(--blue); }

  /* Attitude cards */
  .attitude-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem; }
  .attitude-card {
    padding: 0.75rem; border: 1px solid var(--gray); border-radius: 1rem; text-align: center;
    font-family: 'Roboto Mono', monospace; font-size: 0.65rem; font-weight: 400;
    cursor: pointer; transition: all 0.15s; text-transform: uppercase; letter-spacing: 0.04em;
    line-height: 1.3;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .attitude-card.selected { border-color: #ff00ff; background: #ff00ff; color: var(--white); }

  /* Insight fields */
  .insight-group { margin-bottom: 1.25rem; }
  .insight-label {
    font-family: 'Roboto Mono', monospace; font-size: 0.7rem; font-weight: 500;
    text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.4rem;
    color: #ff00ff;
  }
  .insight-label.insight-general { color: var(--black); }
  .insight-group textarea { min-height: 80px; }

  /* Summary */
  .summary-item {
    display: flex; justify-content: space-between; padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray); font-size: 0.875rem;
  }
  .summary-item .label {
    font-family: 'Roboto Mono', monospace; font-size: 0.75rem;
    text-transform: uppercase; letter-spacing: 0.05em; color: var(--gray-dark);
  }
  .summary-item .value { font-weight: 400; text-align: right; }

  .waiting-message { text-align: center; padding: 3rem 1rem; color: var(--gray-dark); }
  .waiting-message h2 { color: var(--gray-dark); margin-bottom: 1rem; }

  .error-message { color: #c00; font-size: 0.85rem; padding: 0.5rem 0; }

  /* Persistent session code header */
  .session-header {
    font-family: 'Roboto Mono', monospace; font-size: 0.65rem; font-weight: 400;
    text-transform: uppercase; letter-spacing: 0.1em; color: var(--gray-dark);
    text-align: right; padding-bottom: 0.5rem; display: none;
  }

  .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mt-3 { margin-top: 1.5rem; } .mt-4 { margin-top: 2rem; }
  .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mb-3 { margin-bottom: 1.5rem; } .mb-4 { margin-bottom: 2rem; }

  /* PDF template - hidden on screen */
  #pdf-template { display: none; }

  /* Print styles */
  @media print {
    body { background: #fff; display: block; min-height: auto; }
    #app, .toast, #modal-overlay, .bg-circles { display: none !important; }
    #pdf-template {
      display: block !important;
      width: 100%; padding: 0; margin: 0;
      background: #fff; color: #000;
      font-family: 'Space Grotesk', sans-serif; font-size: 11pt; line-height: 1.6;
    }
    #pdf-template h2 {
      font-family: 'Roboto Mono', monospace; font-size: 14pt;
      margin: 24px 0 8px; border-bottom: 2px solid #0000FF; padding-bottom: 4px;
      page-break-after: avoid;
    }
    #pdf-template h3 {
      font-family: 'Roboto Mono', monospace; font-size: 12pt;
      margin: 16px 0 6px; color: #0000FF;
      page-break-after: avoid;
    }
    #pdf-template .pdf-header {
      text-align: center; margin-bottom: 30px;
      border-bottom: 2px solid #000; padding-bottom: 15px;
    }
    #pdf-template .pdf-header h1 {
      font-family: 'Roboto Mono', monospace; font-size: 20pt; margin-bottom: 8px;
    }
    #pdf-template .pdf-meta { font-size: 9pt; color: #888; }
    #pdf-template .pdf-tags { display: flex; flex-wrap: wrap; gap: 4px; margin: 10px 0; }
    #pdf-template .pdf-tag {
      font-family: 'Roboto Mono', monospace; font-size: 8pt;
      padding: 2px 8px; border: 1px solid #ccc; text-transform: uppercase;
    }
    #pdf-template .pdf-section {
      margin-bottom: 20px; white-space: pre-wrap;
      page-break-inside: avoid;
    }
    #pdf-template .pdf-footer {
      text-align: center; margin-top: 30px; padding-top: 15px;
      border-top: 2px solid #000; font-size: 9pt; color: #888;
      page-break-inside: avoid;
    }
    @page { margin: 15mm; }
  }
</style>
</head>
<body>

<!-- Background gradient circles -->
<div class="bg-circles prominent" id="bg-circles">
  <div class="bg-circle bg-circle-1"></div>
  <div class="bg-circle bg-circle-2"></div>
  <div class="bg-circle bg-circle-3"></div>
</div>

<div id="app">

  <!-- Persistent session code -->
  <div class="session-header" id="session-header">Session: <span id="session-header-code"></span></div>

  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-text"></span><br>
    <button class="toast-btn" id="toast-btn" onclick="goToModeratorScreen()">Go there</button>
  </div>

  <!-- Screen 1: Welcome -->
  <div class="screen active" id="screen-welcome">
    <div class="spacer"></div>
    <p style="font-family:'Roboto Mono',monospace; font-weight:300; font-size:0.8rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--gray-dark); text-align:center;" id="welcome-org">Centre for Quantum and Society</p>
    <h1 style="font-family:'Roboto Mono',monospace; font-weight:700; font-size:2rem; text-transform:uppercase; text-align:center; letter-spacing:0.05em; margin:1rem 0;" id="welcome-title">Scenario Tool</h1>
    <p style="text-align:center; color:var(--gray-dark);" class="mb-4" id="welcome-subtitle">Exploring the future of Disruptive Technologies</p>
    <div class="spacer"></div>
    <button class="btn" onclick="showScreen('setup')" id="btn-begin">Begin</button>
  </div>

  <!-- Screen 2: Setup -->
  <div class="screen" id="screen-setup">
    <p class="subtitle" id="label-language">Language</p>
    <div class="toggle-group mb-4">
      <div class="toggle-option active" onclick="setLanguage('en')" id="lang-en">English</div>
      <div class="toggle-option" onclick="setLanguage('nl')" id="lang-nl">Nederlands</div>
    </div>
    <p class="subtitle" id="label-role">Your role</p>
    <button class="btn mb-2" onclick="startAsModerator()" id="btn-moderator">Start as Moderator</button>
    <button class="btn btn-secondary" onclick="startAsViewer()" id="btn-viewer">Join as Viewer</button>
  </div>

  <!-- Screen 3: Session Code -->
  <div class="screen" id="screen-session">
    <div id="session-moderator" style="display:none;">
      <p class="subtitle" id="label-session-code">Session Code</p>
      <div class="session-code-display" id="display-code"></div>
      <p class="mb-4" id="session-share-text">Share this code with your group so they can follow along.</p>
      <button class="btn" onclick="showScreen('cards')" id="btn-to-cards">Continue to Cards</button>
    </div>
    <div id="session-viewer" style="display:none;">
      <p class="subtitle" id="label-enter-code">Enter Session Code</p>
      <input type="text" id="input-code" maxlength="6" placeholder="ABC123" style="text-align:center; font-family:'Roboto Mono',monospace; font-size:1.5rem; letter-spacing:0.2em; text-transform:uppercase; border-radius:1rem;" class="mb-3">
      <div class="error-message" id="join-error" style="display:none;"></div>
      <button class="btn" onclick="joinSession()" id="btn-join">Join</button>
    </div>
  </div>

  <!-- Screen 4: Card Selection -->
  <div class="screen" id="screen-cards">
    <div id="cards-moderator">
      <h2 class="mb-1" id="cards-title">Shape Your Future</h2>
      <p class="subtitle mb-3" id="instruction-cards-moderator">Select the scenario parameters</p>

      <p class="subtitle" id="label-resource">Resource Outlook</p>
      <div class="chip-group">
        <div class="chip selected" id="chip-abundance" onclick="selectChip('resource', 'abundance')"><span id="label-abundance">Abundance</span></div>
        <div class="chip" id="chip-scarce" onclick="selectChip('resource', 'scarce')"><span id="label-scarce">Scarce</span></div>
      </div>

      <p class="subtitle" id="label-stability">System Stability</p>
      <div class="chip-group">
        <div class="chip selected" id="chip-stable" onclick="selectChip('stability', 'stable')"><span id="label-stable">Stable</span></div>
        <div class="chip" id="chip-breaks" onclick="selectChip('stability', 'breaks_down')"><span id="label-breaks">Breaks Down</span></div>
      </div>

      <p class="subtitle" id="label-values">Dominant Value</p>
      <div class="chip-group">
        <div class="chip selected" id="chip-collective" onclick="selectChip('values', 'collectivism')"><span id="label-collective">Collectivism</span></div>
        <div class="chip" id="chip-individual" onclick="selectChip('values', 'individualism')"><span id="label-individual">Individualism</span></div>
      </div>

      <p class="subtitle mt-2" id="label-tech-select">Select 2 Technologies</p>
      <div class="tech-grid" id="tech-grid">
        <div class="tech-card" onclick="toggleTech(this, 'AGI')">AGI</div>
        <div class="tech-card" onclick="toggleTech(this, 'Quantum')">Quantum</div>
        <div class="tech-card" onclick="toggleTech(this, 'BioTech')">BioTech</div>
        <div class="tech-card" onclick="toggleTech(this, 'Robotics')">Robotics</div>
        <div class="tech-card" onclick="toggleTech(this, 'NeuroTech')">NeuroTech</div>
        <div class="tech-card" onclick="toggleTech(this, 'ClimateTech')">ClimateTech</div>
      </div>
      <button class="btn" onclick="generateScenario()" id="btn-generate" disabled>Generate Scenario</button>
      <div id="cards-loading" style="display:none;">
        <div class="loading">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <span id="loading-text">Generating scenario seed...</span>
        </div>
      </div>
    </div>
    <div id="cards-viewer" style="display:none;">
      <div class="waiting-message">
        <div class="loading" style="justify-content:center; margin-bottom:1rem;">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h2 id="viewer-waiting-title">Waiting for Moderator</h2>
        <p class="subtitle" id="instruction-cards-viewer">Waiting for the moderator to select the scenario parameters</p>
        <p id="viewer-waiting-text" class="mt-2"></p>
      </div>
    </div>
  </div>

  <!-- Screen 5: Distant Future -->
  <div class="screen" id="screen-distant">
    <div class="choice-tags" id="tags-distant"></div>
    <div class="timeframe" id="tf-distant">2045 — 2050</div>
    <h2 class="mb-1" id="title-distant">The Distant Future</h2>
    <div class="archetype-badge" id="badge-archetype"></div>
    <div class="scenario-text mb-2" id="text-distant"></div>
    <div class="weak-signals" id="weak-signals-block" style="display:none;">
      <div class="weak-signals-title" id="ws-title">Weak Signals</div>
      <div class="weak-signals-content" id="text-weak-signals"></div>
    </div>
    <div class="facilitation mt-3" id="facilitation-distant" style="display:none;">Take 5 minutes to discuss: What surprised you about this future? What feels inevitable, and what feels like it could still go differently?</div>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="continueToNotSoDistant()" id="btn-to-nsd" style="display:none;">Continue to 2040</button>
    <div class="bottom-nav" id="nav-distant" style="display:none;">
      <button class="nav-btn hidden"></button>
      <button class="nav-btn" onclick="navigateTo('nsd')" id="nav-fwd-distant" style="display:none;"><span id="label-forth">Forth</span> &rarr;</button>
    </div>
  </div>

  <!-- Screen 6: Not So Distant Future -->
  <div class="screen" id="screen-nsd">
    <div class="choice-tags" id="tags-nsd"></div>
    <div class="timeframe" id="tf-nsd">2035 — 2040</div>
    <h2 class="mb-3" id="title-nsd">The Not So Distant Future</h2>
    <div class="scenario-text mb-2" id="text-nsd"></div>
    <div class="facilitation mt-3" id="facilitation-nsd" style="display:none;">Discuss: What would need to happen in the next 15 years for this stepping stone to become reality? What obstacles do you see?</div>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="continueToNear()" id="btn-to-near" style="display:none;">Continue to 2030</button>
    <div class="bottom-nav">
      <button class="nav-btn" onclick="navigateTo('distant')">&larr; <span class="nav-back-label">Back</span></button>
      <button class="nav-btn" onclick="navigateTo('near')" id="nav-fwd-nsd" style="display:none;"><span class="nav-forth-label">Forth</span> &rarr;</button>
    </div>
  </div>

  <!-- Screen 7: Near Future -->
  <div class="screen" id="screen-near">
    <div class="choice-tags" id="tags-near"></div>
    <div class="timeframe" id="tf-near">2027 — 2030</div>
    <h2 class="mb-3" id="title-near">The Near Future</h2>
    <div class="scenario-text mb-2" id="text-near"></div>
    <div class="facilitation mt-3" id="facilitation-near" style="display:none;">Discuss: What in this near future do you recognize from your current work? What decisions being made today could set this path in motion?</div>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="showScreen('intervention')" id="btn-to-intervention" style="display:none;">What if we intervene?</button>
    <div class="bottom-nav">
      <button class="nav-btn" onclick="navigateTo('nsd')">&larr; <span class="nav-back-label">Back</span></button>
      <button class="nav-btn" onclick="navigateTo('intervention')" id="nav-fwd-near" style="display:none;"><span class="nav-forth-label">Forth</span> &rarr;</button>
    </div>
  </div>

  <!-- Screen 8: Intervention -->
  <div class="screen" id="screen-intervention">
    <h2 class="mb-1" id="title-intervention">Intervention</h2>
    <p class="subtitle mb-3" id="instruction-intervention">As a group, agree on one concrete action or strategy your organisation could take today that would alter the trajectory of this future.</p>
    <div id="intervention-moderator">
      <textarea id="input-intervention" placeholder="Describe your intervention..." oninput="updateInterventionCounter()"></textarea>
      <div class="char-counter" id="intervention-counter">0 / 20 min</div>
    </div>
    <div id="intervention-viewer" style="display:none;">
      <textarea id="input-intervention-viewer" readonly placeholder="Waiting for moderator to type..." style="color:var(--gray-dark);"></textarea>
    </div>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="submitIntervention()" id="btn-submit-intervention" disabled>Explore Consequences</button>
    <div class="bottom-nav">
      <button class="nav-btn" onclick="navigateTo('near')">&larr; <span class="nav-back-label">Back</span></button>
      <button class="nav-btn" onclick="navigateTo('consequences')" id="nav-fwd-intervention" style="display:none;"><span class="nav-forth-label">Forth</span> &rarr;</button>
    </div>
  </div>

  <!-- Screen 9: Consequences -->
  <div class="screen" id="screen-consequences">
    <div class="choice-tags" id="tags-consequences"></div>
    <div class="timeframe" id="tf-consequences">Altered Future</div>
    <h2 class="mb-3" id="title-consequences">If You Intervene...</h2>
    <div class="scenario-text mb-2" id="text-consequences"></div>
    <div class="facilitation mt-3" id="facilitation-consequences" style="display:none;">Reflect: Did the consequences of your intervention surprise you? What trade-offs emerged that you didn't expect?</div>
    <button class="btn btn-secondary mt-2" onclick="showOriginalScenario()" id="btn-view-original" style="display:none;">View Original 2050 Scenario</button>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="showScreen('team')" id="btn-to-team" style="display:none;">Continue</button>
    <div class="bottom-nav">
      <button class="nav-btn" onclick="navigateTo('intervention')">&larr; <span class="nav-back-label">Back</span></button>
      <button class="nav-btn hidden"></button>
    </div>
  </div>

  <!-- Screen 10: Team & Attitudes -->
  <div class="screen" id="screen-team">
    <h2 class="mb-3" id="title-team">Your Team</h2>
    <div id="team-moderator">
      <p class="subtitle" id="label-team-name">Team Name</p>
      <input type="text" id="input-team-name" placeholder="Enter your team name..." class="mb-4">
      <p class="subtitle" id="label-attitudes">Which attitudes are at your table?</p>
      <div class="attitude-grid" id="attitude-grid">
        <div class="attitude-card" onclick="toggleAttitude(this, 'Existential Alarmist')">Existential Alarmist</div>
        <div class="attitude-card" onclick="toggleAttitude(this, 'Ethical Crusader')">Ethical Crusader</div>
        <div class="attitude-card" onclick="toggleAttitude(this, 'Governance Guardian')">Governance Guardian</div>
        <div class="attitude-card" onclick="toggleAttitude(this, 'Pragmatic Builder')">Pragmatic Builder</div>
        <div class="attitude-card" onclick="toggleAttitude(this, 'Techno-Utopian')">Techno-Utopian</div>
        <div class="attitude-card" onclick="toggleAttitude(this, 'Accelerationist')">Accelerationist</div>
      </div>
      <div class="spacer"></div>
      <button class="btn" onclick="proceedToInsights()" id="btn-to-insights">Continue to Insights</button>
    </div>
    <div id="team-viewer" style="display:none;">
      <p class="subtitle" id="label-team-name-viewer">Team Name</p>
      <p class="mb-4" style="font-family:'Roboto Mono',monospace; font-size:1.25rem; font-weight:500;" id="viewer-team-name">—</p>
      <p class="subtitle" id="label-attitudes-viewer">Attitudes</p>
      <div class="chip-group" style="flex-wrap:wrap;" id="viewer-attitudes"></div>
      <div class="spacer"></div>
    </div>
  </div>

  <!-- Screen 11: Insights -->
  <div class="screen" id="screen-insights">
    <h2 class="mb-1" id="title-insights">Insights</h2>
    <p class="subtitle mb-3" id="instruction-insights">What insights emerged from each perspective and what general insights emerged?</p>
    <div id="insight-fields"></div>
    <div class="insight-group">
      <div class="insight-label insight-general" id="label-general-insight">General Insights</div>
      <textarea id="input-insight-general" placeholder="Any other reflections..."></textarea>
    </div>
    <div class="spacer"></div>
    <button class="btn mt-3" onclick="submitInsights()" id="btn-submit-insights">Finish</button>
  </div>

  <!-- Screen 12: Closing -->
  <div class="screen" id="screen-closing">
    <div class="spacer"></div>
    <h1 class="mb-2" id="title-closing">Thank You</h1>
    <p class="mb-4" id="text-closing">Your scenario exploration is complete.</p>
    <div id="summary-list" class="mb-4"></div>
    <button class="btn mb-2" onclick="exportPDF()" id="btn-export">Export PDF</button>
    <button class="btn btn-secondary" onclick="endSession()" id="btn-end-session">End Session</button>
    <div class="spacer"></div>
  </div>

  <!-- Screen 13: Session Completed -->
  <div class="screen" id="screen-completed">
    <div class="spacer"></div>
    <h1 class="mb-2" id="title-completed">Session Completed</h1>
    <p class="mb-4" id="text-completed">Thank you for participating and sharing your perspective on the future.</p>
    <div class="spacer"></div>
    <button class="btn" onclick="startOver()" id="btn-start-new">Start a New Session</button>
  </div>

  <!-- Modal: Original Scenario -->
  <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:999; justify-content:center; align-items:center; padding:1rem;">
    <div style="background:var(--white); max-width:430px; width:100%; max-height:80vh; overflow-y:auto; padding:2rem; position:relative; border-radius:1rem;">
      <button onclick="closeModal()" style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; font-family:'Roboto Mono',monospace;">&times;</button>
      <div class="timeframe mb-1">2045 — 2050</div>
      <h2 class="mb-2">The Distant Future</h2>
      <div class="archetype-badge mb-2" id="modal-archetype"></div>
      <div class="scenario-text" id="modal-distant-text"></div>
    </div>
  </div>

</div>

<!-- Hidden PDF template -->
<div id="pdf-template">
  <div class="pdf-header">
    <h1>Scenario Planning Tool</h1>
    <div class="pdf-meta">
      <span id="pdf-team"></span> &nbsp;|&nbsp; <span id="pdf-date"></span> &nbsp;|&nbsp; Session: <span id="pdf-code"></span>
    </div>
    <div class="pdf-meta" id="pdf-attitudes-line"></div>
  </div>
  <div class="pdf-tags" id="pdf-tags"></div>
  <h2>The Distant Future — 2045–2050</h2>
  <div class="pdf-section" id="pdf-distant"></div>
  <h3>Weak Signals</h3>
  <div class="pdf-section" id="pdf-weak-signals"></div>
  <h2>The Not So Distant Future — 2035–2040</h2>
  <div class="pdf-section" id="pdf-nsd"></div>
  <h2>The Near Future — 2027–2030</h2>
  <div class="pdf-section" id="pdf-near"></div>
  <h2>Intervention</h2>
  <div class="pdf-section" id="pdf-intervention"></div>
  <h2>Consequences</h2>
  <div class="pdf-section" id="pdf-consequences"></div>
  <h2>Insights</h2>
  <div class="pdf-section" id="pdf-insights"></div>
  <div class="pdf-footer">Centre for Quantum and Society</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ---------- STATE ----------
const SUPABASE_URL = 'https://sejvhzowjdtuvmrqrgkf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlanZoem93amR0dXZtcnFyZ2tmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzkyNDAsImV4cCI6MjA4NTk1NTI0MH0.ptPCW0i8OHkN847VwWYZGpWSKjtqUWuv_axw_yn9p6o';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const TECHS = ['AGI', 'Quantum', 'BioTech', 'Robotics', 'NeuroTech', 'ClimateTech'];

let state = {
  language: 'en',
  role: null,
  sessionId: null,
  sessionCode: null,
  archetype: null,
  resource_outlook: 'abundance',
  system_stability: 'stable',
  dominant_value: 'collectivism',
  technology_1: null,
  technology_2: null,
  selectedTechs: [],
  seed_output: '',
  distant_future: '',
  weak_signals: '',
  not_so_distant_future: '',
  near_future: '',
  consequences: '',
  intervention_text: '',
  team_name: '',
  selectedAttitudes: [],
  insights_data: {},
};

let realtimeChannel = null;
let moderatorScreen = null;
let toastTimer = null;
let interventionSyncTimer = null;
let pregenB5 = null; // Promise for background B5
let pregenB6 = null; // Promise for background B6

// ---------- i18n ----------
const i18n = {
  en: {
    'welcome-org': 'Centre for Quantum and Society',
    'welcome-title': 'SCENARIO TOOL',
    'welcome-subtitle': 'Exploring the future of Disruptive Technologies',
    'btn-begin': 'Begin',
    'label-language': 'Language',
    'label-role': 'Your role',
    'btn-moderator': 'Start as Moderator',
    'btn-viewer': 'Join as Viewer',
    'label-session-code': 'Session Code',
    'session-share-text': 'Share this code with your group so they can follow along.',
    'btn-to-cards': 'Continue to Cards',
    'label-enter-code': 'Enter Session Code',
    'btn-join': 'Join',
    'cards-title': 'Shape Your Future',
    'label-resource': 'Resource Outlook',
    'label-abundance': 'Abundance',
    'label-scarce': 'Scarce',
    'label-stability': 'System Stability',
    'label-stable': 'Stable',
    'label-breaks': 'Breaks Down',
    'label-values': 'Dominant Value',
    'label-collective': 'Collectivism',
    'label-individual': 'Individualism',
    'label-tech-select': 'Select 2 Technologies',
    'btn-generate': 'Generate Scenario',
    'loading-text': 'Generating scenario seed...',
    'viewer-waiting-title': 'Waiting for Moderator',
    'viewer-waiting-text': 'The moderator is selecting scenario parameters...',
    'tf-distant': '2045 — 2050',
    'title-distant': 'The Distant Future',
    'btn-to-nsd': 'Continue to 2040',
    'tf-nsd': '2035 — 2040',
    'title-nsd': 'The Not So Distant Future',
    'btn-to-near': 'Continue to 2030',
    'tf-near': '2027 — 2030',
    'title-near': 'The Near Future',
    'btn-to-intervention': 'What if we intervene?',
    'title-intervention': 'Intervention',
    'btn-submit-intervention': 'Explore Consequences',
    'tf-consequences': 'Altered Future',
    'title-consequences': 'If You Intervene...',
    'btn-to-team': 'Continue',
    'title-team': 'Your Team',
    'label-team-name': 'Team Name',
    'label-team-name-viewer': 'Team Name',
    'label-attitudes': 'Which attitudes are at your table?',
    'label-attitudes-viewer': 'Attitudes',
    'btn-to-insights': 'Continue to Insights',
    'title-insights': 'Insights',
    'text-insights-prompt': 'What insights emerged from each perspective and what general insights emerged?',
    'label-general-insight': 'General Insights',
    'btn-submit-insights': 'Finish',
    'title-closing': 'Thank You',
    'text-closing': 'Your scenario exploration is complete.',
    'btn-export': 'Export PDF',
    'btn-end-session': 'End Session',
    'title-completed': 'Session Completed',
    'text-completed': 'Thank you for participating and sharing your perspective on the future.',
    'btn-start-new': 'Start a New Session',
    'btn-view-original': 'View Original 2050 Scenario',
    'summary-archetype': 'Archetype',
    'summary-tech': 'Technologies',
    'summary-value': 'Dominant Value',
    'facilitation-distant': 'Take 5 minutes to discuss this future — from your role\'s perspective. What stands out to you? Where do you see opportunity, risk, injustice, or missing structure? Start with your strongest reaction.',
    'facilitation-nsd': 'What would need to happen in the next 15 years for this to become reality? Each of you will see different enablers and obstacles — share what your lens highlights first, then react to each other.',
    'facilitation-near': 'What in this near future do you recognize from your current work? From your role: what decisions being made today should we be paying more attention to?',
    'facilitation-intervention': 'As a group, agree on one concrete action or strategy your organisation could take today that would alter the trajectory of this future.',
    'facilitation-consequences': 'Did the consequences surprise you? From your perspective — what trade-off here is acceptable, and what isn\'t? Where do you disagree with each other?',
    'instruction-cards-moderator': 'Select the scenario parameters',
    'instruction-cards-viewer': 'Waiting for the moderator to select the scenario parameters',
    'instruction-intervention': 'As a group, agree on one concrete action or strategy your organisation could take today that would alter the trajectory of this future.',
    'instruction-insights': 'What insights emerged from each perspective and what general insights emerged?',
    'ws-title': 'Weak Signals',
    'toast-moderator-moved': 'Moderator moved to a new phase',
    'nav-back': 'Back',
    'nav-forth': 'Forth',
    'typing-seed': 'Generating scenario seed...',
    'typing-crafting': 'Crafting the distant future...',
    'typing-checking': 'Checking scenario coherence...',
    'typing-revising': 'Refining the scenario...',
    'typing-signals': 'Scanning for present-day signals...',
  },
  nl: {
    'welcome-org': 'Centre for Quantum and Society',
    'welcome-title': 'SCENARIO TOOL',
    'welcome-subtitle': 'De toekomst van disruptieve technologieën verkennen',
    'btn-begin': 'Begin',
    'label-language': 'Taal',
    'label-role': 'Jouw rol',
    'btn-moderator': 'Start als Moderator',
    'btn-viewer': 'Deelnemen als Kijker',
    'label-session-code': 'Sessiecode',
    'session-share-text': 'Deel deze code met je groep zodat ze kunnen volgen.',
    'btn-to-cards': 'Verder naar Kaarten',
    'label-enter-code': 'Voer Sessiecode in',
    'btn-join': 'Deelnemen',
    'cards-title': 'Vorm Jouw Toekomst',
    'label-resource': 'Grondstoffenvooruitzicht',
    'label-abundance': 'Overvloed',
    'label-scarce': 'Schaars',
    'label-stability': 'Systeemstabiliteit',
    'label-stable': 'Stabiel',
    'label-breaks': 'Instort',
    'label-values': 'Dominante Waarde',
    'label-collective': 'Collectivisme',
    'label-individual': 'Individualisme',
    'label-tech-select': 'Kies 2 Technologieën',
    'btn-generate': 'Genereer Scenario',
    'loading-text': 'Scenario wordt gegenereerd...',
    'viewer-waiting-title': 'Wachten op Moderator',
    'viewer-waiting-text': 'De moderator selecteert scenarioparameters...',
    'tf-distant': '2045 — 2050',
    'title-distant': 'De Verre Toekomst',
    'btn-to-nsd': 'Verder naar 2040',
    'tf-nsd': '2035 — 2040',
    'title-nsd': 'De Niet Zo Verre Toekomst',
    'btn-to-near': 'Verder naar 2030',
    'tf-near': '2027 — 2030',
    'title-near': 'De Nabije Toekomst',
    'btn-to-intervention': 'Wat als we ingrijpen?',
    'title-intervention': 'Interventie',
    'btn-submit-intervention': 'Verken Gevolgen',
    'tf-consequences': 'Veranderde Toekomst',
    'title-consequences': 'Als Je Ingrijpt...',
    'btn-to-team': 'Verder',
    'title-team': 'Jouw Team',
    'label-team-name': 'Teamnaam',
    'label-team-name-viewer': 'Teamnaam',
    'label-attitudes': 'Welke attitudes zitten aan tafel?',
    'label-attitudes-viewer': 'Attitudes',
    'btn-to-insights': 'Verder naar Inzichten',
    'title-insights': 'Inzichten',
    'text-insights-prompt': 'Welke inzichten kwamen naar voren vanuit elk perspectief en welke algemene inzichten zijn er?',
    'label-general-insight': 'Algemene Inzichten',
    'btn-submit-insights': 'Afronden',
    'title-closing': 'Bedankt',
    'text-closing': 'Jullie scenarioverkenning is afgerond.',
    'btn-export': 'Exporteer PDF',
    'btn-end-session': 'Sessie Beëindigen',
    'title-completed': 'Sessie Afgerond',
    'text-completed': 'Bedankt voor je deelname en het delen van jouw perspectief op de toekomst.',
    'btn-start-new': 'Start een Nieuwe Sessie',
    'btn-view-original': 'Bekijk Origineel 2050 Scenario',
    'summary-archetype': 'Archetype',
    'summary-tech': 'Technologieën',
    'summary-value': 'Dominante Waarde',
    'facilitation-distant': 'Neem 5 minuten om deze toekomst te bespreken — vanuit jullie rol. Wat valt jullie op? Waar zien jullie kansen, risico\'s, onrecht of ontbrekende structuur? Begin met jullie sterkste reactie.',
    'facilitation-nsd': 'Wat zou er in de komende 15 jaar moeten gebeuren om dit werkelijkheid te laten worden? Ieder van jullie ziet andere aanjagers en obstakels — deel eerst wat jullie lens belicht, en reageer daarna op elkaar.',
    'facilitation-near': 'Wat herkennen jullie in deze nabije toekomst vanuit jullie huidige werk? Vanuit jullie rol: aan welke beslissingen die nu worden genomen zouden we meer aandacht moeten besteden?',
    'facilitation-intervention': 'Kom als groep tot één concrete actie of strategie die jullie organisatie vandaag zou kunnen nemen om het traject van deze toekomst te veranderen.',
    'facilitation-consequences': 'Verrasten de gevolgen jullie? Vanuit jullie perspectief — welke afweging is hier acceptabel en welke niet? Waar zijn jullie het met elkaar oneens?',
    'instruction-cards-moderator': 'Selecteer de scenarioparameters',
    'instruction-cards-viewer': 'Wachten tot de moderator de scenarioparameters selecteert',
    'instruction-intervention': 'Kom als groep tot één concrete actie of strategie die jullie organisatie vandaag zou kunnen nemen om het traject van deze toekomst te veranderen.',
    'instruction-insights': 'Welke inzichten kwamen naar voren vanuit elk perspectief en welke algemene inzichten zijn er?',
    'ws-title': 'Zwakke Signalen',
    'toast-moderator-moved': 'De moderator is naar een nieuwe fase gegaan',
    'nav-back': 'Terug',
    'nav-forth': 'Volgende',
    'typing-seed': 'Scenario wordt gegenereerd...',
    'typing-crafting': 'De verre toekomst wordt gecreëerd...',
    'typing-checking': 'Scenario coherentie wordt gecontroleerd...',
    'typing-revising': 'Het scenario wordt verfijnd...',
    'typing-signals': 'Zwakke signalen worden opgespoord...',
  }
};

function t(key) { return (i18n[state.language] && i18n[state.language][key]) || i18n.en[key] || key; }

function applyTranslations() {
  for (const key of Object.keys(i18n.en)) {
    const el = document.getElementById(key);
    if (el && (el.tagName === 'BUTTON' || el.tagName === 'DIV' || el.tagName === 'SPAN' || el.tagName === 'P' || el.tagName === 'H1' || el.tagName === 'H2')) {
      el.textContent = t(key);
    }
  }
  document.querySelectorAll('.nav-back-label').forEach(el => el.textContent = t('nav-back'));
  document.querySelectorAll('.nav-forth-label').forEach(el => el.textContent = t('nav-forth'));
}

// ---------- MARKDOWN BOLD PARSING ----------
function renderMarkdown(text) {
  // Escape HTML
  let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Convert **bold** and *bold* markers to <strong> tags
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<strong>$1</strong>');
  // Convert double newlines to paragraphs, single newlines to spaces
  const paragraphs = html.split(/\n\s*\n/).map(p => p.replace(/\n/g, ' ').trim()).filter(p => p);
  if (paragraphs.length > 1) html = paragraphs.map(p => '<p>' + p + '</p>').join('');
  return html;
}

// ---------- CHOICE TAGS ----------
function renderChoiceTags(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const statementTags = [state.resource_outlook, state.system_stability, state.dominant_value].filter(Boolean);
  const techTags = [state.technology_1, state.technology_2].filter(Boolean);
  container.innerHTML =
    statementTags.map(t => `<span class="choice-tag tag-statement">${t}</span>`).join('') +
    techTags.map(t => `<span class="choice-tag tag-tech">${t}</span>`).join('');
}

function renderAllTags() {
  ['tags-distant', 'tags-nsd', 'tags-near', 'tags-consequences'].forEach(id => renderChoiceTags(id));
}

// ---------- BACKGROUND CIRCLES INTENSITY ----------
function setBgIntensity(prominent) {
  const bg = document.getElementById('bg-circles');
  if (prominent) bg.classList.add('prominent');
  else bg.classList.remove('prominent');
}

// ---------- NAVIGATION ----------
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + name);
  if (screen) screen.classList.add('active');

  // Background intensity: prominent on welcome/closing/completed
  setBgIntensity(['welcome', 'closing', 'completed'].includes(name));

  if (['distant', 'nsd', 'near', 'consequences'].includes(name)) renderChoiceTags('tags-' + name);

  if (state.role === 'viewer') {
    const modButtons = ['btn-to-nsd', 'btn-to-near', 'btn-to-intervention', 'btn-to-team', 'btn-submit-intervention'];
    modButtons.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    if (name === 'intervention') {
      document.getElementById('intervention-moderator').style.display = 'none';
      document.getElementById('intervention-viewer').style.display = 'block';
    }
    if (name === 'team') {
      document.getElementById('team-moderator').style.display = 'none';
      document.getElementById('team-viewer').style.display = 'block';
    }
    if (name === 'insights') {
      // Viewer sees read-only insights from moderator
      document.getElementById('btn-submit-insights').style.display = 'none';
    }
  }

  if (state.role === 'moderator' && state.sessionId) {
    const statusMap = {
      'cards': 'card_selection', 'distant': 'distant_future', 'nsd': 'not_so_distant_future',
      'near': 'near_future', 'intervention': 'intervention', 'consequences': 'consequences',
      'team': 'team', 'insights': 'insights', 'closing': 'closing',
    };
    if (statusMap[name]) {
      sb.from('sessions').update({ status: statusMap[name] }).eq('session_id', state.sessionId).then();
    }
  }
}

function navigateTo(screenName) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + screenName);
  if (screen) screen.classList.add('active');
  setBgIntensity(false);
  if (['distant', 'nsd', 'near', 'consequences'].includes(screenName)) renderChoiceTags('tags-' + screenName);
}

// ---------- TOAST ----------
function showToast(text, targetScreen) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-text').textContent = text;
  moderatorScreen = targetScreen;
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => goToModeratorScreen(), 5000);
}

function goToModeratorScreen() {
  document.getElementById('toast').classList.remove('show');
  if (toastTimer) clearTimeout(toastTimer);
  if (moderatorScreen) showScreen(moderatorScreen);
}

function showBriefToast(text) {
  const toast = document.getElementById('toast');
  document.getElementById('toast-text').textContent = text;
  document.getElementById('toast-btn').style.display = 'none';
  toast.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    document.getElementById('toast-btn').style.display = '';
  }, 3000);
}

// ---------- LANGUAGE ----------
function setLanguage(lang) {
  state.language = lang;
  document.querySelectorAll('.toggle-option').forEach(el => el.classList.remove('active'));
  document.getElementById('lang-' + lang).classList.add('active');
  applyTranslations();
}

// ---------- ROLES ----------
async function startAsModerator() {
  state.role = 'moderator';
  state.sessionCode = generateCode();
  const { data, error } = await sb.from('sessions').insert({
    session_code: state.sessionCode, language: state.language,
    status: 'card_selection', sector_name: 'Energy',
  }).select().single();
  if (error) { console.error('Failed to create session:', error); return; }
  state.sessionId = data.session_id;
  document.getElementById('display-code').textContent = state.sessionCode;
  document.getElementById('session-header-code').textContent = state.sessionCode;
  document.getElementById('session-header').style.display = 'block';
  document.getElementById('session-moderator').style.display = 'block';
  document.getElementById('session-viewer').style.display = 'none';
  showScreen('session');
}

async function startAsViewer() {
  state.role = 'viewer';
  document.getElementById('session-moderator').style.display = 'none';
  document.getElementById('session-viewer').style.display = 'block';
  showScreen('session');
}

async function joinSession() {
  const code = document.getElementById('input-code').value.trim().toUpperCase();
  const errEl = document.getElementById('join-error');
  if (code.length < 4) { errEl.textContent = 'Please enter a valid session code.'; errEl.style.display = 'block'; return; }
  const { data, error } = await sb.from('sessions').select('*').eq('session_code', code).single();
  if (error || !data) { errEl.textContent = 'Session not found.'; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  state.sessionId = data.session_id;
  state.sessionCode = data.session_code;
  state.language = (data.language || 'en').toLowerCase();
  document.getElementById('session-header-code').textContent = state.sessionCode;
  document.getElementById('session-header').style.display = 'block';
  applyTranslations();
  loadSessionData(data);
  subscribeToSession();
  navigateToStatus(data.status);
}

function loadSessionData(data) {
  const prevDistant = state.distant_future;
  const prevWeakSignals = state.weak_signals;
  const prevNSD = state.not_so_distant_future;
  const prevNear = state.near_future;
  const prevConsequences = state.consequences;

  state.archetype = data.archetype;
  state.resource_outlook = data.dimension_a_value;
  state.system_stability = data.dimension_b_value;
  state.dominant_value = data.nuance;
  state.technology_1 = data.tech_a_name;
  state.technology_2 = data.tech_b_name;
  state.seed_output = data.b1_output || '';
  state.distant_future = data.b2_output || '';
  state.weak_signals = data.b4_output || '';
  state.not_so_distant_future = data.b5_output || '';
  state.near_future = data.b6_output || '';
  state.consequences = data.b8_output || '';
  state.intervention_text = data.user_intervention || '';
  state.team_name = data.team_name || '';
  state.selectedAttitudes = data.attitudes ? data.attitudes.split(',') : [];
  state.insights_data = data.insights_data || {};

  const isViewer = state.role === 'viewer';

  if (state.distant_future) {
    if (isViewer && state.distant_future !== prevDistant && prevDistant === '') {
      simulateStreaming('text-distant', state.distant_future);
    } else {
      document.getElementById('text-distant').innerHTML = renderMarkdown(state.distant_future);
    }
    showFacilitation('distant');
    document.getElementById('nav-distant').style.display = 'flex';
  }
  if (state.weak_signals) {
    if (isViewer && state.weak_signals !== prevWeakSignals && prevWeakSignals === '') {
      document.getElementById('weak-signals-block').style.display = 'block';
      simulateStreaming('text-weak-signals', state.weak_signals);
    } else {
      document.getElementById('text-weak-signals').innerHTML = renderMarkdown(state.weak_signals);
      document.getElementById('weak-signals-block').style.display = 'block';
    }
  }
  if (state.not_so_distant_future) {
    if (isViewer && state.not_so_distant_future !== prevNSD && prevNSD === '') {
      simulateStreaming('text-nsd', state.not_so_distant_future);
    } else {
      document.getElementById('text-nsd').innerHTML = renderMarkdown(state.not_so_distant_future);
    }
    showFacilitation('nsd');
    document.getElementById('nav-fwd-distant').style.display = '';
    document.getElementById('nav-fwd-nsd').style.display = '';
  }
  if (state.near_future) {
    if (isViewer && state.near_future !== prevNear && prevNear === '') {
      simulateStreaming('text-near', state.near_future);
    } else {
      document.getElementById('text-near').innerHTML = renderMarkdown(state.near_future);
    }
    showFacilitation('near');
    document.getElementById('nav-fwd-near').style.display = '';
  }
  if (state.consequences) {
    if (isViewer && state.consequences !== prevConsequences && prevConsequences === '') {
      simulateStreaming('text-consequences', state.consequences);
    } else {
      document.getElementById('text-consequences').innerHTML = renderMarkdown(state.consequences);
    }
    showFacilitation('consequences');
    document.getElementById('btn-view-original').style.display = 'block';
    document.getElementById('nav-fwd-intervention').style.display = '';
  }
  if (state.archetype) document.getElementById('badge-archetype').textContent = state.archetype;
  if (state.intervention_text && document.getElementById('input-intervention-viewer')) {
    document.getElementById('input-intervention-viewer').value = state.intervention_text;
    document.getElementById('input-intervention-viewer').style.color = 'var(--black)';
  }
  // Update viewer team display
  if (isViewer) {
    document.getElementById('viewer-team-name').textContent = state.team_name || '—';
    const attContainer = document.getElementById('viewer-attitudes');
    if (attContainer && state.selectedAttitudes.length) {
      attContainer.innerHTML = state.selectedAttitudes.map(a =>
        `<span class="chip selected" style="flex:none; padding:0.5rem 1rem; cursor:default;">${a}</span>`
      ).join('');
    }
    // Update viewer insight fields to match moderator's attitudes
    if (state.insights_data && Object.keys(state.insights_data).length) {
      updateViewerInsights();
    }
  }
  renderAllTags();
}

function navigateToStatus(status) {
  const screenMap = {
    'card_selection': 'cards', 'generating': 'cards',
    'generating_seed': 'cards', 'generating_scenario': 'cards',
    'checking_coherence': 'cards', 'revising_scenario': 'cards',
    'generating_signals': 'distant',
    'distant_future': 'distant',
    'not_so_distant_future': 'nsd', 'near_future': 'near', 'intervention': 'intervention',
    'consequences': 'consequences', 'team': 'team', 'insights': 'insights', 'closing': 'closing',
  };
  const screen = screenMap[status] || 'cards';
  if (state.role === 'viewer' && (screen === 'cards' || isGeneratingStatus(status))) {
    document.getElementById('cards-moderator').style.display = 'none';
    document.getElementById('cards-viewer').style.display = 'block';
    updateViewerGenerationPhase(status);
  }
  showScreen(screen);
}

function isGeneratingStatus(status) {
  return ['generating', 'generating_seed', 'generating_scenario', 'checking_coherence', 'revising_scenario', 'generating_signals'].includes(status);
}

function updateViewerGenerationPhase(status) {
  const phaseMap = {
    'generating_seed': 'typing-seed',
    'generating_scenario': 'typing-crafting',
    'checking_coherence': 'typing-checking',
    'revising_scenario': 'typing-revising',
    'generating_signals': 'typing-signals',
  };
  const textEl = document.getElementById('viewer-waiting-text');
  if (phaseMap[status]) {
    textEl.textContent = t(phaseMap[status]);
  }
}

function subscribeToSession() {
  if (realtimeChannel) sb.removeChannel(realtimeChannel);
  realtimeChannel = sb
    .channel('session-' + state.sessionId)
    .on('postgres_changes', {
      event: 'UPDATE', schema: 'public', table: 'sessions',
      filter: 'session_id=eq.' + state.sessionId,
    }, (payload) => {
      const data = payload.new;
      const oldStatus = state.status;
      state.status = data.status;
      loadSessionData(data);
      if (state.role === 'viewer' && data.status !== oldStatus) {
        if (isGeneratingStatus(data.status)) {
          // Update generation phase indicator for viewer
          updateViewerGenerationPhase(data.status);
        } else {
          // Auto-navigate viewer to the new screen immediately
          const screenMap = {
            'card_selection': 'cards', 'distant_future': 'distant',
            'not_so_distant_future': 'nsd', 'near_future': 'near', 'intervention': 'intervention',
            'consequences': 'consequences', 'team': 'team', 'insights': 'insights', 'closing': 'closing',
          };
          const target = screenMap[data.status] || 'cards';
          showScreen(target);
          showBriefToast(t('toast-moderator-moved'));
        }
      }
      if (state.role === 'viewer' && data.user_intervention) {
        const viewerTA = document.getElementById('input-intervention-viewer');
        if (viewerTA) { viewerTA.value = data.user_intervention; viewerTA.style.color = 'var(--black)'; }
      }
    }).subscribe();
}

// ---------- SESSION CODE ----------
function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

// ---------- CHIP SELECTION (replaces sliders) ----------
function selectChip(group, value) {
  if (group === 'resource') {
    state.resource_outlook = value;
    document.getElementById('chip-abundance').classList.toggle('selected', value === 'abundance');
    document.getElementById('chip-scarce').classList.toggle('selected', value === 'scarce');
  } else if (group === 'stability') {
    state.system_stability = value;
    document.getElementById('chip-stable').classList.toggle('selected', value === 'stable');
    document.getElementById('chip-breaks').classList.toggle('selected', value === 'breaks_down');
  } else if (group === 'values') {
    state.dominant_value = value;
    document.getElementById('chip-collective').classList.toggle('selected', value === 'collectivism');
    document.getElementById('chip-individual').classList.toggle('selected', value === 'individualism');
  }
}

// ---------- TECH SELECTION ----------
function toggleTech(el, name) {
  if (el.classList.contains('disabled')) return;
  if (el.classList.contains('selected')) {
    el.classList.remove('selected');
    state.selectedTechs = state.selectedTechs.filter(t => t !== name);
  } else {
    if (state.selectedTechs.length >= 2) return;
    el.classList.add('selected');
    state.selectedTechs.push(name);
  }
  document.querySelectorAll('.tech-card').forEach(card => {
    if (!card.classList.contains('selected')) card.classList.toggle('disabled', state.selectedTechs.length >= 2);
  });
  state.technology_1 = state.selectedTechs[0] || null;
  state.technology_2 = state.selectedTechs[1] || null;
  document.getElementById('btn-generate').disabled = state.selectedTechs.length < 2;
}

// ---------- ATTITUDES ----------
function toggleAttitude(el, name) {
  el.classList.toggle('selected');
  if (el.classList.contains('selected')) state.selectedAttitudes.push(name);
  else state.selectedAttitudes = state.selectedAttitudes.filter(a => a !== name);
}

function proceedToInsights() {
  state.team_name = document.getElementById('input-team-name').value.trim();
  sb.from('sessions').update({
    team_name: state.team_name, attitudes: state.selectedAttitudes.join(','),
  }).eq('session_id', state.sessionId).then();
  const container = document.getElementById('insight-fields');
  container.innerHTML = '';
  state.selectedAttitudes.forEach(att => {
    const group = document.createElement('div');
    group.className = 'insight-group';
    group.innerHTML = `<div class="insight-label">${att}</div><textarea id="input-insight-${att.replace(/\s+/g, '-').toLowerCase()}" placeholder="Insight from the ${att} perspective..."></textarea>`;
    container.appendChild(group);
  });
  showScreen('insights');
}

function updateViewerInsights() {
  const container = document.getElementById('insight-fields');
  container.innerHTML = '';
  for (const [att, value] of Object.entries(state.insights_data)) {
    if (att === 'General') continue;
    const group = document.createElement('div');
    group.className = 'insight-group';
    group.innerHTML = `<div class="insight-label">${att}</div><textarea readonly style="color:var(--black);">${value}</textarea>`;
    container.appendChild(group);
  }
  const generalEl = document.getElementById('input-insight-general');
  if (generalEl && state.insights_data['General']) {
    generalEl.value = state.insights_data['General'];
    generalEl.readOnly = true;
    generalEl.style.color = 'var(--black)';
  }
}

// ---------- INTERVENTION ----------
function updateInterventionCounter() {
  const input = document.getElementById('input-intervention');
  const counter = document.getElementById('intervention-counter');
  const len = input.value.trim().length;
  counter.textContent = `${len} / 20 min`;
  counter.classList.toggle('met', len >= 20);
  document.getElementById('btn-submit-intervention').disabled = len < 20;
  if (interventionSyncTimer) clearTimeout(interventionSyncTimer);
  interventionSyncTimer = setTimeout(() => {
    sb.from('sessions').update({ user_intervention: input.value }).eq('session_id', state.sessionId).then();
  }, 300);
}

// ---------- ARCHETYPE ----------
function deriveArchetype() {
  if (state.resource_outlook === 'abundance' && state.system_stability === 'stable') return 'Continued Growth';
  if (state.resource_outlook === 'scarce' && state.system_stability === 'breaks_down') return 'Collapse';
  if (state.resource_outlook === 'scarce' && state.system_stability === 'stable') return 'Discipline';
  if (state.resource_outlook === 'abundance' && state.system_stability === 'breaks_down') return 'Transformation';
  return 'Continued Growth';
}

// ---------- API HELPERS ----------
function buildSessionData(extra) {
  return {
    archetype: state.archetype, resource_outlook: state.resource_outlook,
    system_stability: state.system_stability, dominant_value: state.dominant_value,
    technology_1: state.technology_1, technology_2: state.technology_2,
    sector_name: 'Energy', language: state.language,
    seed_output: state.seed_output, distant_future: state.distant_future,
    not_so_distant_future: state.not_so_distant_future, near_future: state.near_future,
    intervention_text: state.intervention_text, ...extra,
  };
}

async function silentAPICall(promptId, extraData) {
  const sessionData = buildSessionData(extraData);
  const response = await fetch('/api/generate', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ promptId, sessionId: state.sessionId, sessionData }),
  });
  if (!response.ok) throw new Error('API error: ' + response.status);
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let accumulated = '', buffer = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      try { const p = JSON.parse(line.slice(6).trim()); if (p.done) break; if (p.text) accumulated += p.text; } catch (e) {}
    }
  }
  return accumulated;
}

async function streamFromAPI(promptId, targetElementId, sessionField, extraData) {
  const targetEl = document.getElementById(targetElementId);
  targetEl.innerHTML = '<span class="cursor"></span>';
  let accumulated = '';
  const sessionData = buildSessionData(extraData);
  const response = await fetch('/api/generate', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ promptId, sessionId: state.sessionId, sessionData }),
  });
  if (!response.ok) {
    targetEl.innerHTML = '<span class="error-message">Error generating content. Please try again.</span>';
    throw new Error('API error: ' + response.status);
  }
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '', updateTimer = null;
  function scheduleUpdate() {
    if (updateTimer) clearTimeout(updateTimer);
    updateTimer = setTimeout(async () => {
      if (accumulated && sessionField) await sb.from('sessions').update({ [sessionField]: accumulated }).eq('session_id', state.sessionId);
    }, 2000);
  }
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const jsonStr = line.slice(6).trim();
      if (!jsonStr) continue;
      try {
        const parsed = JSON.parse(jsonStr);
        if (parsed.done) break;
        if (parsed.error) { targetEl.innerHTML = `<span class="error-message">${parsed.error}</span>`; return accumulated; }
        if (parsed.text) { accumulated += parsed.text; targetEl.innerHTML = renderMarkdown(accumulated) + '<span class="cursor"></span>'; scheduleUpdate(); }
      } catch (e) {}
    }
  }
  targetEl.innerHTML = renderMarkdown(accumulated);
  if (updateTimer) clearTimeout(updateTimer);
  if (sessionField) await sb.from('sessions').update({ [sessionField]: accumulated }).eq('session_id', state.sessionId);
  return accumulated;
}

// ---------- SIMULATED STREAMING ----------
let streamingTimer = null;
function simulateStreaming(elementId, text, speed = 15) {
  return new Promise((resolve) => {
    const el = document.getElementById(elementId);
    if (!el || !text) { if (el) el.innerHTML = renderMarkdown(text || ''); resolve(); return; }
    if (streamingTimer) clearInterval(streamingTimer);
    let i = 0;
    const len = text.length;
    el.innerHTML = '<span class="cursor"></span>';
    streamingTimer = setInterval(() => {
      // Stream in chunks of 2-4 chars for natural feel
      const chunk = Math.min(len, i + 2 + Math.floor(Math.random() * 3));
      i = chunk;
      el.innerHTML = renderMarkdown(text.substring(0, i)) + (i < len ? '<span class="cursor"></span>' : '');
      if (i >= len) { clearInterval(streamingTimer); streamingTimer = null; resolve(); }
    }, speed);
  });
}

function stopSimulatedStreaming() {
  if (streamingTimer) { clearInterval(streamingTimer); streamingTimer = null; }
}

// ---------- TYPING LOADER ----------
let typingInterval = null;
function startTypingLoader(elementId, text) {
  const el = document.getElementById(elementId);
  let i = 0;
  el.innerHTML = '<span class="cursor"></span>';
  if (typingInterval) clearInterval(typingInterval);
  typingInterval = setInterval(() => {
    if (i < text.length) { el.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>'; i++; }
  }, 40);
}

function updateTypingLoader(elementId, text) {
  if (typingInterval) clearInterval(typingInterval);
  const el = document.getElementById(elementId);
  let i = 0;
  el.innerHTML = '<span class="cursor"></span>';
  typingInterval = setInterval(() => {
    if (i < text.length) { el.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>'; i++; }
  }, 40);
}

function stopTypingLoader(elementId) {
  if (typingInterval) { clearInterval(typingInterval); typingInterval = null; }
  const el = document.getElementById(elementId);
  if (el) el.innerHTML = '';
}

// ---------- PIPELINE ----------
async function generateScenario() {
  state.archetype = deriveArchetype();
  document.getElementById('badge-archetype').textContent = state.archetype;
  await sb.from('sessions').update({
    dimension_a_value: state.resource_outlook, dimension_b_value: state.system_stability,
    nuance: state.dominant_value, tech_a_name: state.technology_1, tech_b_name: state.technology_2,
    archetype: state.archetype, status: 'generating',
  }).eq('session_id', state.sessionId);

  document.getElementById('btn-generate').style.display = 'none';
  document.getElementById('cards-loading').style.display = 'block';

  try {
    console.log('[Pipeline] Starting B1...');
    document.getElementById('loading-text').textContent = t('loading-text');
    await sb.from('sessions').update({ status: 'generating_seed' }).eq('session_id', state.sessionId);
    state.seed_output = await silentAPICall('b1');
    console.log('[Pipeline] B1 complete');
    await sb.from('sessions').update({ b1_output: state.seed_output }).eq('session_id', state.sessionId);

    await sb.from('sessions').update({ status: 'generating_scenario' }).eq('session_id', state.sessionId);
    showScreen('distant');
    renderAllTags();

    console.log('[Pipeline] Starting B2 (silent)...');
    startTypingLoader('text-distant', t('typing-crafting'));
    state.distant_future = await silentAPICall('b2');
    console.log('[Pipeline] B2 complete');
    // Don't save b2_output yet — wait for B3 QA to prevent viewer seeing unreviewed text

    try {
      console.log('[Pipeline] Starting B3...');
      await sb.from('sessions').update({ status: 'checking_coherence' }).eq('session_id', state.sessionId);
      updateTypingLoader('text-distant', t('typing-checking'));
      const assessment = await silentAPICall('b3');
      console.log('[Pipeline] B3 result:', assessment.substring(0, 80));

      if (assessment.toUpperCase().includes('NEEDS REVISION')) {
        console.log('[Pipeline] B3 NEEDS REVISION, running B3_revision...');
        await sb.from('sessions').update({ status: 'revising_scenario' }).eq('session_id', state.sessionId);
        updateTypingLoader('text-distant', t('typing-revising'));
        state.distant_future = await silentAPICall('b3_revision', { b3_fix_instructions: assessment });
        console.log('[Pipeline] B3_revision complete');
      }
    } catch (e) {
      console.warn('[Pipeline] B3 QA failed, using original B2 output:', e);
    }
    // Save final reviewed output
    await sb.from('sessions').update({ b2_output: state.distant_future }).eq('session_id', state.sessionId);

    stopTypingLoader('text-distant');
    await simulateStreaming('text-distant', state.distant_future);

    // Start B5 pre-generation in background (doesn't need B4)
    console.log('[Pipeline] Starting B5 in background...');
    pregenB5 = silentAPICall('b5').then(async (result) => {
      state.not_so_distant_future = result;
      console.log('[Pipeline] B5 background complete');
      await sb.from('sessions').update({ b5_output: result }).eq('session_id', state.sessionId);
      // Chain B6 in background
      console.log('[Pipeline] Starting B6 in background...');
      pregenB6 = silentAPICall('b6').then(async (result6) => {
        state.near_future = result6;
        console.log('[Pipeline] B6 background complete');
        await sb.from('sessions').update({ b6_output: result6 }).eq('session_id', state.sessionId);
        // Chain B7 in background
        console.log('[Pipeline] Starting B7 in background...');
        silentAPICall('b7').catch(e => console.warn('B7 background failed:', e));
      });
      return result;
    }).catch(e => { console.error('[Pipeline] B5 background failed:', e); pregenB5 = null; });

    // B4 streams in parallel with background B5
    await sb.from('sessions').update({ status: 'generating_signals' }).eq('session_id', state.sessionId);
    document.getElementById('weak-signals-block').style.display = 'block';
    document.getElementById('text-weak-signals').innerHTML = '<div class="loading"><div class="dot"></div><div class="dot"></div><div class="dot"></div><span>Scanning for present-day signals...</span></div>';
    console.log('[Pipeline] Starting B4...');
    state.weak_signals = await streamFromAPI('b4', 'text-weak-signals', 'b4_output');
    console.log('[Pipeline] B4 complete');

    await sb.from('sessions').update({ status: 'distant_future' }).eq('session_id', state.sessionId);
    showFacilitation('distant');
    document.getElementById('btn-to-nsd').style.display = 'block';
    document.getElementById('nav-distant').style.display = 'flex';
  } catch (error) {
    console.error('[Pipeline] Error:', error);
    stopTypingLoader('text-distant');
  }
}

async function continueToNotSoDistant() {
  document.getElementById('btn-to-nsd').style.display = 'none';
  await sb.from('sessions').update({ status: 'not_so_distant_future' }).eq('session_id', state.sessionId);
  showScreen('nsd');
  if (pregenB5) {
    // Wait for background B5 to finish if still running
    if (!state.not_so_distant_future) {
      startTypingLoader('text-nsd', t('typing-crafting'));
      await pregenB5;
      stopTypingLoader('text-nsd');
    }
    await simulateStreaming('text-nsd', state.not_so_distant_future);
  } else {
    // Fallback: generate normally if background failed
    state.not_so_distant_future = await streamFromAPI('b5', 'text-nsd', 'b5_output');
  }
  showFacilitation('nsd');
  document.getElementById('btn-to-near').style.display = 'block';
  document.getElementById('nav-fwd-distant').style.display = '';
  document.getElementById('nav-fwd-nsd').style.display = '';
}

async function continueToNear() {
  document.getElementById('btn-to-near').style.display = 'none';
  await sb.from('sessions').update({ status: 'near_future' }).eq('session_id', state.sessionId);
  showScreen('near');
  if (pregenB6) {
    // Wait for background B6 to finish if still running
    if (!state.near_future) {
      startTypingLoader('text-near', t('typing-crafting'));
      await pregenB6;
      stopTypingLoader('text-near');
    }
    await simulateStreaming('text-near', state.near_future);
  } else {
    // Fallback: generate normally if background failed
    state.near_future = await streamFromAPI('b6', 'text-near', 'b6_output');
    silentAPICall('b7').catch(e => console.warn('B7 failed:', e));
  }
  showFacilitation('near');
  document.getElementById('btn-to-intervention').style.display = 'block';
  document.getElementById('nav-fwd-near').style.display = '';
}

async function submitIntervention() {
  const text = document.getElementById('input-intervention').value.trim();
  if (text.length < 20) return;
  state.intervention_text = text;
  await sb.from('sessions').update({ user_intervention: text, status: 'consequences' }).eq('session_id', state.sessionId);
  showScreen('consequences');
  state.consequences = await streamFromAPI('b8', 'text-consequences', 'b8_output');
  showFacilitation('consequences');
  document.getElementById('btn-view-original').style.display = 'block';
  document.getElementById('btn-to-team').style.display = 'block';
  document.getElementById('nav-fwd-near').style.display = '';
  document.getElementById('nav-fwd-intervention').style.display = '';
}

async function submitInsights() {
  const insightsData = {};
  state.selectedAttitudes.forEach(att => {
    const id = 'input-insight-' + att.replace(/\s+/g, '-').toLowerCase();
    const el = document.getElementById(id);
    if (el && el.value.trim()) insightsData[att] = el.value.trim();
  });
  const generalInsight = document.getElementById('input-insight-general').value.trim();
  if (generalInsight) insightsData['General'] = generalInsight;
  state.insights_data = insightsData;
  await sb.from('sessions').update({
    insights_data: insightsData, user_insights: JSON.stringify(insightsData), status: 'closing',
  }).eq('session_id', state.sessionId);
  buildSummary();
  showScreen('closing');
}

function buildSummary() {
  const list = document.getElementById('summary-list');
  const items = [
    { label: t('summary-archetype'), value: state.archetype || '—' },
    { label: t('summary-tech'), value: [state.technology_1, state.technology_2].filter(Boolean).join(', ') || '—' },
    { label: t('summary-value'), value: state.dominant_value || '—' },
  ];
  list.innerHTML = items.map(item => `<div class="summary-item"><span class="label">${item.label}</span><span class="value">${item.value}</span></div>`).join('');
}

// ---------- PDF EXPORT ----------
function exportPDF() {
  document.getElementById('pdf-team').textContent = state.team_name || 'Unnamed Team';
  document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();
  document.getElementById('pdf-code').textContent = state.sessionCode || '';
  document.getElementById('pdf-attitudes-line').textContent = state.selectedAttitudes.length
    ? 'Attitudes: ' + state.selectedAttitudes.join(', ') : '';
  const tags = [state.resource_outlook, state.system_stability, state.dominant_value, state.archetype, state.technology_1, state.technology_2].filter(Boolean);
  document.getElementById('pdf-tags').innerHTML = tags.map(t => `<span class="pdf-tag">${t}</span>`).join('');
  document.getElementById('pdf-distant').textContent = state.distant_future || '';
  document.getElementById('pdf-weak-signals').textContent = state.weak_signals || '';
  document.getElementById('pdf-nsd').textContent = state.not_so_distant_future || '';
  document.getElementById('pdf-near').textContent = state.near_future || '';
  document.getElementById('pdf-intervention').textContent = state.intervention_text || '';
  document.getElementById('pdf-consequences').textContent = state.consequences || '';
  let insightsText = '';
  for (const [key, val] of Object.entries(state.insights_data)) { insightsText += `${key}:\n${val}\n\n`; }
  document.getElementById('pdf-insights').textContent = insightsText || 'No insights recorded.';
  window.print();
}

// ---------- MODAL ----------
function showOriginalScenario() {
  document.getElementById('modal-archetype').textContent = state.archetype || '';
  document.getElementById('modal-distant-text').innerHTML = renderMarkdown(state.distant_future || '');
  document.getElementById('modal-overlay').style.display = 'flex';
}
function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

// ---------- END SESSION ----------
function endSession() { showScreen('completed'); }

// ---------- FACILITATION HELPERS ----------
function showFacilitation(screenName) {
  const el = document.getElementById('facilitation-' + screenName);
  if (el) el.style.display = 'block';
}

// ---------- RESET ----------
function startOver() {
  if (realtimeChannel) { sb.removeChannel(realtimeChannel); realtimeChannel = null; }
  pregenB5 = null; pregenB6 = null;
  document.getElementById('session-header').style.display = 'none';
  state = {
    language: state.language, role: null, sessionId: null, sessionCode: null,
    archetype: null, resource_outlook: 'abundance', system_stability: 'stable',
    dominant_value: 'collectivism', technology_1: null, technology_2: null, selectedTechs: [],
    seed_output: '', distant_future: '', weak_signals: '', not_so_distant_future: '',
    near_future: '', consequences: '', intervention_text: '', team_name: '',
    selectedAttitudes: [], insights_data: {},
  };
  document.querySelectorAll('.tech-card').forEach(c => c.classList.remove('selected', 'disabled'));
  document.querySelectorAll('.attitude-card').forEach(c => c.classList.remove('selected'));
  // Reset chips
  document.getElementById('chip-abundance').classList.add('selected');
  document.getElementById('chip-scarce').classList.remove('selected');
  document.getElementById('chip-stable').classList.add('selected');
  document.getElementById('chip-breaks').classList.remove('selected');
  document.getElementById('chip-collective').classList.add('selected');
  document.getElementById('chip-individual').classList.remove('selected');
  document.getElementById('btn-generate').disabled = true;
  document.getElementById('btn-generate').style.display = 'block';
  document.getElementById('cards-loading').style.display = 'none';
  document.getElementById('text-distant').textContent = '';
  document.getElementById('text-weak-signals').textContent = '';
  document.getElementById('weak-signals-block').style.display = 'none';
  document.getElementById('text-nsd').textContent = '';
  document.getElementById('text-near').textContent = '';
  document.getElementById('text-consequences').textContent = '';
  document.getElementById('input-intervention').value = '';
  document.getElementById('intervention-counter').textContent = '0 / 20 min';
  document.getElementById('btn-submit-intervention').disabled = true;
  document.getElementById('input-team-name').value = '';
  document.getElementById('insight-fields').innerHTML = '';
  document.getElementById('input-insight-general').value = '';
  document.getElementById('btn-to-nsd').style.display = 'none';
  document.getElementById('btn-to-near').style.display = 'none';
  document.getElementById('btn-to-intervention').style.display = 'none';
  document.getElementById('btn-to-team').style.display = 'none';
  document.getElementById('btn-view-original').style.display = 'none';
  ['facilitation-distant', 'facilitation-nsd', 'facilitation-near', 'facilitation-consequences'].forEach(id => {
    const el = document.getElementById(id); if (el) el.style.display = 'none';
  });
  document.getElementById('nav-distant').style.display = 'none';
  ['nav-fwd-distant', 'nav-fwd-nsd', 'nav-fwd-near', 'nav-fwd-intervention'].forEach(id => {
    const el = document.getElementById(id); if (el) el.style.display = 'none';
  });
  document.getElementById('cards-moderator').style.display = 'block';
  document.getElementById('cards-viewer').style.display = 'none';
  document.getElementById('team-moderator').style.display = 'block';
  document.getElementById('team-viewer').style.display = 'none';
  document.getElementById('btn-submit-insights').style.display = '';
  document.getElementById('summary-list').innerHTML = '';
  showScreen('welcome');
}

// ---------- INIT ----------
</script>
</body>
</html>
