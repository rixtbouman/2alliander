<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scenario Planning Tool</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;700&family=Shape:wght@100;300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --black: #000;
    --white: #fff;
    --accent: #7877f6;
    --blue: #0000FF;
    --gray: #e5e5e5;
    --gray-dark: #888;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Shape', sans-serif;
    font-weight: 100;
    background: var(--white);
    color: var(--black);
    min-height: 100dvh;
    display: flex;
    justify-content: center;
    -webkit-font-smoothing: antialiased;
  }

  #app {
    width: 100%;
    max-width: 430px;
    min-height: 100dvh;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
  }

  h1, h2, h3 {
    font-family: 'Roboto Mono', monospace;
    font-weight: 400;
    letter-spacing: -0.02em;
  }

  h1 { font-size: 1.75rem; line-height: 1.2; }
  h2 { font-size: 1.25rem; line-height: 1.3; }
  h3 { font-size: 1rem; }

  p { line-height: 1.6; font-size: 0.95rem; }

  .screen {
    display: none;
    flex-direction: column;
    flex: 1;
    animation: fadeIn 0.3s ease;
  }

  .screen.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .spacer { flex: 1; }

  .btn {
    display: block;
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--black);
    background: var(--white);
    color: var(--black);
    font-family: 'Roboto Mono', monospace;
    font-size: 0.875rem;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.15s ease;
    text-align: center;
  }

  .btn:hover { background: var(--black); color: var(--white); }
  .btn:active { transform: scale(0.98); }

  .btn-primary {
    background: var(--black);
    color: var(--white);
  }
  .btn-primary:hover { background: var(--accent); border-color: var(--accent); }

  .btn-accent {
    background: var(--accent);
    color: var(--white);
    border-color: var(--accent);
  }
  .btn-accent:hover { background: var(--blue); border-color: var(--blue); }

  .btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .btn:disabled:hover {
    background: var(--white);
    color: var(--black);
  }

  .btn + .btn { margin-top: 0.75rem; }

  .subtitle {
    color: var(--gray-dark);
    font-size: 0.8rem;
    font-family: 'Roboto Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .session-code-display {
    font-family: 'Roboto Mono', monospace;
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: 0.3em;
    text-align: center;
    padding: 2rem 0;
    color: var(--accent);
  }

  input[type="text"], textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--gray);
    font-family: 'Shape', sans-serif;
    font-size: 1rem;
    font-weight: 300;
    outline: none;
    transition: border-color 0.15s;
    background: var(--white);
  }

  input[type="text"]:focus, textarea:focus {
    border-color: var(--accent);
  }

  textarea {
    min-height: 120px;
    resize: vertical;
    line-height: 1.6;
  }

  /* Toggle switch for language */
  .toggle-group {
    display: flex;
    border: 2px solid var(--black);
    overflow: hidden;
  }

  .toggle-option {
    flex: 1;
    padding: 0.75rem;
    text-align: center;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .toggle-option.active {
    background: var(--black);
    color: var(--white);
  }

  /* Statement sliders */
  .slider-group {
    margin-bottom: 1.5rem;
  }

  .slider-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    font-family: 'Roboto Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    color: var(--gray-dark);
  }

  .slider-labels span.selected-label {
    color: var(--black);
    font-weight: 500;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: var(--gray);
    outline: none;
    margin: 0.5rem 0;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--white);
    box-shadow: 0 0 0 2px var(--accent);
  }

  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid var(--white);
    box-shadow: 0 0 0 2px var(--accent);
  }

  /* Tech grid */
  .tech-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .tech-card {
    padding: 1rem;
    border: 2px solid var(--gray);
    text-align: center;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.8rem;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .tech-card.selected {
    border-color: var(--accent);
    background: var(--accent);
    color: var(--white);
  }

  .tech-card.disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  /* Scenario text */
  .scenario-text {
    font-size: 1rem;
    line-height: 1.8;
    font-weight: 300;
    white-space: pre-wrap;
  }

  .scenario-text .cursor {
    display: inline-block;
    width: 2px;
    height: 1.1em;
    background: var(--accent);
    margin-left: 2px;
    animation: blink 0.8s infinite;
    vertical-align: text-bottom;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .timeframe {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 0.25rem;
  }

  .archetype-badge {
    display: inline-block;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.25rem 0.75rem;
    border: 1px solid var(--accent);
    color: var(--accent);
    margin-bottom: 1rem;
  }

  /* Loading spinner */
  .loading {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Roboto Mono', monospace;
    font-size: 0.8rem;
    color: var(--gray-dark);
    padding: 2rem 0;
  }

  .loading .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 1.2s infinite;
  }

  .loading .dot:nth-child(2) { animation-delay: 0.2s; }
  .loading .dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
  }

  .mt-1 { margin-top: 0.5rem; }
  .mt-2 { margin-top: 1rem; }
  .mt-3 { margin-top: 1.5rem; }
  .mt-4 { margin-top: 2rem; }
  .mb-1 { margin-bottom: 0.5rem; }
  .mb-2 { margin-bottom: 1rem; }
  .mb-3 { margin-bottom: 1.5rem; }
  .mb-4 { margin-bottom: 2rem; }

  .waiting-message {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-dark);
  }

  .waiting-message h2 {
    color: var(--gray-dark);
    margin-bottom: 1rem;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray);
    font-size: 0.875rem;
  }

  .summary-item .label {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-dark);
  }

  .summary-item .value {
    font-weight: 400;
    text-align: right;
  }

  .error-message {
    color: #c00;
    font-size: 0.85rem;
    padding: 0.5rem 0;
  }
</style>
</head>
<body>

<div id="app">

  <!-- Screen 1: Welcome -->
  <div class="screen active" id="screen-welcome">
    <div class="spacer"></div>
    <p class="subtitle">Alliander</p>
    <h1 class="mb-2" id="welcome-title">Scenario Planning Tool</h1>
    <p class="mb-4" id="welcome-subtitle">Explore possible energy futures through collaborative scenario building and backcasting.</p>
    <div class="spacer"></div>
    <button class="btn btn-primary" onclick="showScreen('setup')" id="btn-begin">Begin</button>
  </div>

  <!-- Screen 2: Setup -->
  <div class="screen" id="screen-setup">
    <p class="subtitle" id="label-language">Language</p>
    <div class="toggle-group mb-4">
      <div class="toggle-option active" onclick="setLanguage('en')" id="lang-en">English</div>
      <div class="toggle-option" onclick="setLanguage('nl')" id="lang-nl">Nederlands</div>
    </div>

    <p class="subtitle" id="label-role">Your role</p>
    <button class="btn btn-primary mb-2" onclick="startAsModerator()" id="btn-moderator">Start as Moderator</button>
    <button class="btn" onclick="startAsViewer()" id="btn-viewer">Join as Viewer</button>
  </div>

  <!-- Screen 3: Session Code -->
  <div class="screen" id="screen-session">
    <!-- Moderator view -->
    <div id="session-moderator" style="display:none;">
      <p class="subtitle" id="label-session-code">Session Code</p>
      <div class="session-code-display" id="display-code"></div>
      <p class="mb-4" id="session-share-text">Share this code with your group so they can follow along.</p>
      <button class="btn btn-primary" onclick="showScreen('cards')" id="btn-to-cards">Continue to Cards</button>
    </div>
    <!-- Viewer view -->
    <div id="session-viewer" style="display:none;">
      <p class="subtitle" id="label-enter-code">Enter Session Code</p>
      <input type="text" id="input-code" maxlength="6" placeholder="ABC123" style="text-align:center; font-family:'Roboto Mono',monospace; font-size:1.5rem; letter-spacing:0.2em; text-transform:uppercase;" class="mb-3">
      <div class="error-message" id="join-error" style="display:none;"></div>
      <button class="btn btn-primary" onclick="joinSession()" id="btn-join">Join</button>
    </div>
  </div>

  <!-- Screen 4: Card Selection -->
  <div class="screen" id="screen-cards">
    <!-- Moderator: card selection UI -->
    <div id="cards-moderator">
      <h2 class="mb-3" id="cards-title">Shape Your Future</h2>

      <div class="slider-group">
        <p class="subtitle" id="label-resource">Resource Outlook</p>
        <div class="slider-labels">
          <span class="selected-label" id="label-abundance">Abundance</span>
          <span id="label-scarce">Scarce</span>
        </div>
        <input type="range" min="0" max="1" value="0" step="1" id="slider-resource" oninput="updateSliderLabels()">
      </div>

      <div class="slider-group">
        <p class="subtitle" id="label-stability">System Stability</p>
        <div class="slider-labels">
          <span class="selected-label" id="label-stable">Stable</span>
          <span id="label-breaks">Breaks Down</span>
        </div>
        <input type="range" min="0" max="1" value="0" step="1" id="slider-stability" oninput="updateSliderLabels()">
      </div>

      <div class="slider-group">
        <p class="subtitle" id="label-values">Dominant Value</p>
        <div class="slider-labels">
          <span class="selected-label" id="label-collective">Collectivism</span>
          <span id="label-individual">Individualism</span>
        </div>
        <input type="range" min="0" max="1" value="0" step="1" id="slider-values" oninput="updateSliderLabels()">
      </div>

      <p class="subtitle mt-2" id="label-tech-select">Select 2 Technologies</p>
      <div class="tech-grid" id="tech-grid">
        <div class="tech-card" onclick="toggleTech(this, 'AGI')">AGI</div>
        <div class="tech-card" onclick="toggleTech(this, 'Quantum')">Quantum</div>
        <div class="tech-card" onclick="toggleTech(this, 'BioTech')">BioTech</div>
        <div class="tech-card" onclick="toggleTech(this, 'Robotics')">Robotics</div>
        <div class="tech-card" onclick="toggleTech(this, 'NeuroTech')">NeuroTech</div>
        <div class="tech-card" onclick="toggleTech(this, 'ClimateTech')">ClimateTech</div>
      </div>

      <button class="btn btn-accent" onclick="generateScenario()" id="btn-generate" disabled>Generate Scenario</button>

      <!-- Loading state -->
      <div id="cards-loading" style="display:none;">
        <div class="loading">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <span id="loading-text">Generating scenario seed...</span>
        </div>
      </div>
    </div>

    <!-- Viewer: waiting -->
    <div id="cards-viewer" style="display:none;">
      <div class="waiting-message">
        <div class="loading" style="justify-content:center; margin-bottom:1rem;">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <h2 id="viewer-waiting-title">Waiting for Moderator</h2>
        <p id="viewer-waiting-text">The moderator is selecting scenario parameters...</p>
      </div>
    </div>
  </div>

  <!-- Screen 5: Distant Future (2045-2050) -->
  <div class="screen" id="screen-distant">
    <div class="timeframe" id="tf-distant">2045 — 2050</div>
    <h2 class="mb-1" id="title-distant">The Distant Future</h2>
    <div class="archetype-badge" id="badge-archetype"></div>
    <div class="scenario-text mb-4" id="text-distant"></div>
    <div class="spacer"></div>
    <button class="btn btn-primary" onclick="continueToNotSoDistant()" id="btn-to-nsd" style="display:none;">Continue to 2040</button>
  </div>

  <!-- Screen 6: Not So Distant Future (2035-2040) -->
  <div class="screen" id="screen-nsd">
    <div class="timeframe" id="tf-nsd">2035 — 2040</div>
    <h2 class="mb-3" id="title-nsd">The Not So Distant Future</h2>
    <div class="scenario-text mb-4" id="text-nsd"></div>
    <div class="spacer"></div>
    <button class="btn btn-primary" onclick="continueToNear()" id="btn-to-near" style="display:none;">Continue to 2030</button>
  </div>

  <!-- Screen 7: Near Future (2027-2030) -->
  <div class="screen" id="screen-near">
    <div class="timeframe" id="tf-near">2027 — 2030</div>
    <h2 class="mb-3" id="title-near">The Near Future</h2>
    <div class="scenario-text mb-4" id="text-near"></div>
    <div class="spacer"></div>
    <button class="btn btn-primary" onclick="showScreen('intervention')" id="btn-to-intervention" style="display:none;">What if we intervene?</button>
  </div>

  <!-- Screen 8: Intervention -->
  <div class="screen" id="screen-intervention">
    <h2 class="mb-2" id="title-intervention">Intervention</h2>
    <p class="mb-3" id="text-intervention-prompt">What action or strategy could your organisation take to alter this future?</p>
    <textarea id="input-intervention" placeholder="Describe your intervention..."></textarea>
    <div class="spacer"></div>
    <button class="btn btn-accent mt-3" onclick="submitIntervention()" id="btn-submit-intervention">Explore Consequences</button>
  </div>

  <!-- Screen 9: Consequences -->
  <div class="screen" id="screen-consequences">
    <div class="timeframe" id="tf-consequences">Altered Future</div>
    <h2 class="mb-3" id="title-consequences">If You Intervene...</h2>
    <div class="scenario-text mb-4" id="text-consequences"></div>
    <div class="spacer"></div>
    <button class="btn btn-primary" onclick="showScreen('insights')" id="btn-to-insights" style="display:none;">What did we learn?</button>
  </div>

  <!-- Screen 10: Insights -->
  <div class="screen" id="screen-insights">
    <h2 class="mb-2" id="title-insights">Insights</h2>
    <p class="mb-3" id="text-insights-prompt">What insights have emerged from exploring this scenario?</p>
    <textarea id="input-insights" placeholder="Share your reflections..."></textarea>
    <div class="spacer"></div>
    <button class="btn btn-primary mt-3" onclick="submitInsights()" id="btn-submit-insights">Finish</button>
  </div>

  <!-- Screen 11: Closing -->
  <div class="screen" id="screen-closing">
    <div class="spacer"></div>
    <h1 class="mb-2" id="title-closing">Thank You</h1>
    <p class="mb-4" id="text-closing">Your scenario exploration is complete. Here's a summary of your session.</p>
    <div id="summary-list" class="mb-4"></div>
    <div class="spacer"></div>
    <button class="btn" onclick="startOver()" id="btn-new-session">Start New Session</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ---------- STATE ----------
const SUPABASE_URL = 'https://sejvhzowjdtuvmrqrgkf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlanZoem93amR0dXZtcnFyZ2tmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzkyNDAsImV4cCI6MjA4NTk1NTI0MH0.ptPCW0i8OHkN847VwWYZGpWSKjtqUWuv_axw_yn9p6o';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let state = {
  language: 'en',
  role: null,       // 'moderator' | 'viewer'
  sessionId: null,
  sessionCode: null,
  archetype: null,
  resource_outlook: 'abundance',
  system_stability: 'stable',
  dominant_value: 'collectivism',
  technology_1: null,
  technology_2: null,
  selectedTechs: [],
  // pipeline outputs cached locally
  seed_output: '',
  distant_future: '',
  not_so_distant_future: '',
  near_future: '',
  consequences: '',
  intervention_text: '',
  insights: '',
};

let realtimeChannel = null;

// ---------- i18n ----------
const i18n = {
  en: {
    'welcome-title': 'Scenario Planning Tool',
    'welcome-subtitle': 'Explore possible energy futures through collaborative scenario building and backcasting.',
    'btn-begin': 'Begin',
    'label-language': 'Language',
    'label-role': 'Your role',
    'btn-moderator': 'Start as Moderator',
    'btn-viewer': 'Join as Viewer',
    'label-session-code': 'Session Code',
    'session-share-text': 'Share this code with your group so they can follow along.',
    'btn-to-cards': 'Continue to Cards',
    'label-enter-code': 'Enter Session Code',
    'btn-join': 'Join',
    'cards-title': 'Shape Your Future',
    'label-resource': 'Resource Outlook',
    'label-abundance': 'Abundance',
    'label-scarce': 'Scarce',
    'label-stability': 'System Stability',
    'label-stable': 'Stable',
    'label-breaks': 'Breaks Down',
    'label-values': 'Dominant Value',
    'label-collective': 'Collectivism',
    'label-individual': 'Individualism',
    'label-tech-select': 'Select 2 Technologies',
    'btn-generate': 'Generate Scenario',
    'loading-text': 'Generating scenario seed...',
    'viewer-waiting-title': 'Waiting for Moderator',
    'viewer-waiting-text': 'The moderator is selecting scenario parameters...',
    'tf-distant': '2045 — 2050',
    'title-distant': 'The Distant Future',
    'btn-to-nsd': 'Continue to 2040',
    'tf-nsd': '2035 — 2040',
    'title-nsd': 'The Not So Distant Future',
    'btn-to-near': 'Continue to 2030',
    'tf-near': '2027 — 2030',
    'title-near': 'The Near Future',
    'btn-to-intervention': 'What if we intervene?',
    'title-intervention': 'Intervention',
    'text-intervention-prompt': 'What action or strategy could your organisation take to alter this future?',
    'btn-submit-intervention': 'Explore Consequences',
    'tf-consequences': 'Altered Future',
    'title-consequences': 'If You Intervene...',
    'btn-to-insights': 'What did we learn?',
    'title-insights': 'Insights',
    'text-insights-prompt': 'What insights have emerged from exploring this scenario?',
    'btn-submit-insights': 'Finish',
    'title-closing': 'Thank You',
    'text-closing': 'Your scenario exploration is complete. Here\'s a summary of your session.',
    'btn-new-session': 'Start New Session',
    'summary-archetype': 'Archetype',
    'summary-tech': 'Technologies',
    'summary-value': 'Dominant Value',
  },
  nl: {
    'welcome-title': 'Scenarioplanning Tool',
    'welcome-subtitle': 'Verken mogelijke energietoekomsten door middel van gezamenlijke scenariobouw en backcasting.',
    'btn-begin': 'Begin',
    'label-language': 'Taal',
    'label-role': 'Jouw rol',
    'btn-moderator': 'Start als Moderator',
    'btn-viewer': 'Deelnemen als Kijker',
    'label-session-code': 'Sessiecode',
    'session-share-text': 'Deel deze code met je groep zodat ze kunnen volgen.',
    'btn-to-cards': 'Verder naar Kaarten',
    'label-enter-code': 'Voer Sessiecode in',
    'btn-join': 'Deelnemen',
    'cards-title': 'Vorm Jouw Toekomst',
    'label-resource': 'Grondstoffenvooruitzicht',
    'label-abundance': 'Overvloed',
    'label-scarce': 'Schaars',
    'label-stability': 'Systeemstabiliteit',
    'label-stable': 'Stabiel',
    'label-breaks': 'Instort',
    'label-values': 'Dominante Waarde',
    'label-collective': 'Collectivisme',
    'label-individual': 'Individualisme',
    'label-tech-select': 'Kies 2 Technologieën',
    'btn-generate': 'Genereer Scenario',
    'loading-text': 'Scenario wordt gegenereerd...',
    'viewer-waiting-title': 'Wachten op Moderator',
    'viewer-waiting-text': 'De moderator selecteert scenarioparameters...',
    'tf-distant': '2045 — 2050',
    'title-distant': 'De Verre Toekomst',
    'btn-to-nsd': 'Verder naar 2040',
    'tf-nsd': '2035 — 2040',
    'title-nsd': 'De Niet Zo Verre Toekomst',
    'btn-to-near': 'Verder naar 2030',
    'tf-near': '2027 — 2030',
    'title-near': 'De Nabije Toekomst',
    'btn-to-intervention': 'Wat als we ingrijpen?',
    'title-intervention': 'Interventie',
    'text-intervention-prompt': 'Welke actie of strategie zou jouw organisatie kunnen nemen om deze toekomst te veranderen?',
    'btn-submit-intervention': 'Verken Gevolgen',
    'tf-consequences': 'Veranderde Toekomst',
    'title-consequences': 'Als Je Ingrijpt...',
    'btn-to-insights': 'Wat hebben we geleerd?',
    'title-insights': 'Inzichten',
    'text-insights-prompt': 'Welke inzichten zijn naar voren gekomen bij het verkennen van dit scenario?',
    'btn-submit-insights': 'Afronden',
    'title-closing': 'Bedankt',
    'text-closing': 'Jullie scenarioverkenning is afgerond. Hier is een samenvatting van de sessie.',
    'btn-new-session': 'Nieuwe Sessie Starten',
    'summary-archetype': 'Archetype',
    'summary-tech': 'Technologieën',
    'summary-value': 'Dominante Waarde',
  }
};

function t(key) {
  return (i18n[state.language] && i18n[state.language][key]) || i18n.en[key] || key;
}

function applyTranslations() {
  for (const key of Object.keys(i18n.en)) {
    const el = document.getElementById(key);
    if (el) {
      if (el.tagName === 'BUTTON' || el.tagName === 'DIV' || el.tagName === 'SPAN' || el.tagName === 'P' || el.tagName === 'H1' || el.tagName === 'H2') {
        el.textContent = t(key);
      }
    }
  }
}

// ---------- NAVIGATION ----------
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById('screen-' + name);
  if (screen) screen.classList.add('active');

  // Update session status in Supabase if moderator
  if (state.role === 'moderator' && state.sessionId) {
    const statusMap = {
      'cards': 'card_selection',
      'distant': 'distant_future',
      'nsd': 'not_so_distant_future',
      'near': 'near_future',
      'intervention': 'intervention',
      'consequences': 'consequences',
      'insights': 'insights',
      'closing': 'closing',
    };
    if (statusMap[name]) {
      sb.from('sessions').update({ status: statusMap[name] }).eq('session_id', state.sessionId).then();
    }
  }
}

// ---------- LANGUAGE ----------
function setLanguage(lang) {
  state.language = lang;
  document.querySelectorAll('.toggle-option').forEach(el => el.classList.remove('active'));
  document.getElementById('lang-' + lang).classList.add('active');
  applyTranslations();
}

// ---------- ROLES ----------
async function startAsModerator() {
  state.role = 'moderator';
  state.sessionCode = generateCode();

  // Create session in Supabase
  const { data, error } = await sb.from('sessions').insert({
    session_code: state.sessionCode,
    language: state.language,
    status: 'card_selection',
    sector_name: 'Energy',
  }).select().single();

  if (error) {
    console.error('Failed to create session:', error);
    return;
  }

  state.sessionId = data.session_id;
  document.getElementById('display-code').textContent = state.sessionCode;
  document.getElementById('session-moderator').style.display = 'block';
  document.getElementById('session-viewer').style.display = 'none';
  showScreen('session');
}

async function startAsViewer() {
  state.role = 'viewer';
  document.getElementById('session-moderator').style.display = 'none';
  document.getElementById('session-viewer').style.display = 'block';
  showScreen('session');
}

async function joinSession() {
  const code = document.getElementById('input-code').value.trim().toUpperCase();
  const errEl = document.getElementById('join-error');

  if (code.length < 4) {
    errEl.textContent = 'Please enter a valid session code.';
    errEl.style.display = 'block';
    return;
  }

  const { data, error } = await sb.from('sessions').select('*').eq('session_code', code).single();

  if (error || !data) {
    errEl.textContent = 'Session not found. Check the code and try again.';
    errEl.style.display = 'block';
    return;
  }

  errEl.style.display = 'none';
  state.sessionId = data.session_id;
  state.sessionCode = data.session_code;
  state.language = (data.language || 'en').toLowerCase();
  applyTranslations();

  // Load existing session data
  loadSessionData(data);

  // Subscribe to realtime updates
  subscribeToSession();

  // Navigate to the correct screen based on session status
  navigateToStatus(data.status);
}

function loadSessionData(data) {
  state.archetype = data.archetype;
  state.resource_outlook = data.dimension_a_value;
  state.system_stability = data.dimension_b_value;
  state.dominant_value = data.nuance;
  state.technology_1 = data.tech_a_name;
  state.technology_2 = data.tech_b_name;
  state.seed_output = data.b1_output || '';
  state.distant_future = data.b2_output || '';
  state.not_so_distant_future = data.b5_output || '';
  state.near_future = data.b6_output || '';
  state.consequences = data.b8_output || '';
  state.intervention_text = data.user_intervention || '';
  state.insights = data.user_insights || '';

  // Populate text on screens
  if (state.distant_future) {
    document.getElementById('text-distant').textContent = state.distant_future;
  }
  if (state.not_so_distant_future) {
    document.getElementById('text-nsd').textContent = state.not_so_distant_future;
  }
  if (state.near_future) {
    document.getElementById('text-near').textContent = state.near_future;
  }
  if (state.consequences) {
    document.getElementById('text-consequences').textContent = state.consequences;
  }
  if (state.archetype) {
    document.getElementById('badge-archetype').textContent = state.archetype;
  }
}

function navigateToStatus(status) {
  const screenMap = {
    'card_selection': 'cards',
    'generating': 'cards',
    'distant_future': 'distant',
    'not_so_distant_future': 'nsd',
    'near_future': 'near',
    'intervention': 'intervention',
    'consequences': 'consequences',
    'insights': 'insights',
    'closing': 'closing',
  };

  const screen = screenMap[status] || 'cards';

  // For viewer on cards screen, show waiting UI
  if (state.role === 'viewer' && screen === 'cards') {
    document.getElementById('cards-moderator').style.display = 'none';
    document.getElementById('cards-viewer').style.display = 'block';
  }

  showScreen(screen);
}

function subscribeToSession() {
  if (realtimeChannel) {
    sb.removeChannel(realtimeChannel);
  }

  realtimeChannel = sb
    .channel('session-' + state.sessionId)
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'sessions',
      filter: 'session_id=eq.' + state.sessionId,
    }, (payload) => {
      const data = payload.new;
      loadSessionData(data);
      navigateToStatus(data.status);

      // Show continue buttons on viewer screens if content loaded
      updateViewerButtons();
    })
    .subscribe();
}

function updateViewerButtons() {
  if (state.distant_future) {
    document.getElementById('text-distant').textContent = state.distant_future;
  }
  if (state.not_so_distant_future) {
    document.getElementById('text-nsd').textContent = state.not_so_distant_future;
  }
  if (state.near_future) {
    document.getElementById('text-near').textContent = state.near_future;
  }
  if (state.consequences) {
    document.getElementById('text-consequences').textContent = state.consequences;
  }
}

// ---------- SESSION CODE ----------
function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

// ---------- SLIDER LABELS ----------
function updateSliderLabels() {
  const resource = document.getElementById('slider-resource').value;
  const stability = document.getElementById('slider-stability').value;
  const values = document.getElementById('slider-values').value;

  // Resource
  document.getElementById('label-abundance').classList.toggle('selected-label', resource === '0');
  document.getElementById('label-scarce').classList.toggle('selected-label', resource === '1');

  // Stability
  document.getElementById('label-stable').classList.toggle('selected-label', stability === '0');
  document.getElementById('label-breaks').classList.toggle('selected-label', stability === '1');

  // Values
  document.getElementById('label-collective').classList.toggle('selected-label', values === '0');
  document.getElementById('label-individual').classList.toggle('selected-label', values === '1');

  state.resource_outlook = resource === '0' ? 'abundance' : 'scarce';
  state.system_stability = stability === '0' ? 'stable' : 'breaks_down';
  state.dominant_value = values === '0' ? 'collectivism' : 'individualism';
}

// ---------- TECH SELECTION ----------
function toggleTech(el, name) {
  if (el.classList.contains('disabled')) return;

  if (el.classList.contains('selected')) {
    el.classList.remove('selected');
    state.selectedTechs = state.selectedTechs.filter(t => t !== name);
  } else {
    if (state.selectedTechs.length >= 2) return;
    el.classList.add('selected');
    state.selectedTechs.push(name);
  }

  // Disable unselected cards if 2 already selected
  document.querySelectorAll('.tech-card').forEach(card => {
    if (!card.classList.contains('selected')) {
      card.classList.toggle('disabled', state.selectedTechs.length >= 2);
    }
  });

  state.technology_1 = state.selectedTechs[0] || null;
  state.technology_2 = state.selectedTechs[1] || null;

  document.getElementById('btn-generate').disabled = state.selectedTechs.length < 2;
}

// ---------- ARCHETYPE MAPPING ----------
function deriveArchetype() {
  if (state.resource_outlook === 'abundance' && state.system_stability === 'stable') return 'Continued Growth';
  if (state.resource_outlook === 'scarce' && state.system_stability === 'breaks_down') return 'Collapse';
  if (state.resource_outlook === 'scarce' && state.system_stability === 'stable') return 'Discipline';
  if (state.resource_outlook === 'abundance' && state.system_stability === 'breaks_down') return 'Transformation';
  return 'Continued Growth';
}

// ---------- STREAMING ----------
async function streamFromAPI(promptId, targetElementId, sessionField) {
  const targetEl = document.getElementById(targetElementId);
  targetEl.innerHTML = '<span class="cursor"></span>';
  let accumulated = '';

  const sessionData = {
    archetype: state.archetype,
    resource_outlook: state.resource_outlook,
    system_stability: state.system_stability,
    dominant_value: state.dominant_value,
    technology_1: state.technology_1,
    technology_2: state.technology_2,
    language: state.language,
    seed_output: state.seed_output,
    distant_future: state.distant_future,
    not_so_distant_future: state.not_so_distant_future,
    near_future: state.near_future,
    intervention_text: state.intervention_text,
  };

  const response = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      promptId,
      sessionId: state.sessionId,
      sessionData,
    }),
  });

  if (!response.ok) {
    targetEl.innerHTML = '<span class="error-message">Error generating content. Please try again.</span>';
    throw new Error('API error: ' + response.status);
  }

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  let updateTimer = null;

  // Periodically save to Supabase
  function scheduleUpdate() {
    if (updateTimer) clearTimeout(updateTimer);
    updateTimer = setTimeout(async () => {
      if (accumulated && sessionField) {
        await sb.from('sessions').update({ [sessionField]: accumulated }).eq('session_id', state.sessionId);
      }
    }, 2000);
  }

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });

    // Parse SSE lines
    const lines = buffer.split('\n');
    buffer = lines.pop(); // keep incomplete line in buffer

    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const jsonStr = line.slice(6).trim();
      if (!jsonStr) continue;

      try {
        const parsed = JSON.parse(jsonStr);
        if (parsed.done) break;
        if (parsed.error) {
          targetEl.innerHTML = `<span class="error-message">${parsed.error}</span>`;
          return accumulated;
        }
        if (parsed.text) {
          accumulated += parsed.text;
          targetEl.innerHTML = accumulated + '<span class="cursor"></span>';
          scheduleUpdate();
        }
      } catch (e) {
        // skip malformed JSON
      }
    }
  }

  // Remove cursor, set final text
  targetEl.textContent = accumulated;

  // Final save to Supabase
  if (updateTimer) clearTimeout(updateTimer);
  if (sessionField) {
    await sb.from('sessions').update({ [sessionField]: accumulated }).eq('session_id', state.sessionId);
  }

  return accumulated;
}

// Silent call (no streaming to UI)
async function silentAPICall(promptId) {
  const sessionData = {
    archetype: state.archetype,
    resource_outlook: state.resource_outlook,
    system_stability: state.system_stability,
    dominant_value: state.dominant_value,
    technology_1: state.technology_1,
    technology_2: state.technology_2,
    language: state.language,
    seed_output: state.seed_output,
    distant_future: state.distant_future,
    not_so_distant_future: state.not_so_distant_future,
    near_future: state.near_future,
    intervention_text: state.intervention_text,
  };

  const response = await fetch('/api/generate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      promptId,
      sessionId: state.sessionId,
      sessionData,
    }),
  });

  if (!response.ok) throw new Error('API error: ' + response.status);

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let accumulated = '';
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      try {
        const parsed = JSON.parse(line.slice(6).trim());
        if (parsed.done) break;
        if (parsed.text) accumulated += parsed.text;
      } catch (e) {}
    }
  }

  return accumulated;
}

// ---------- PIPELINE ----------
async function generateScenario() {
  state.archetype = deriveArchetype();
  document.getElementById('badge-archetype').textContent = state.archetype;

  // Update session with card selections
  await sb.from('sessions').update({
    dimension_a_value: state.resource_outlook,
    dimension_b_value: state.system_stability,
    nuance: state.dominant_value,
    tech_a_name: state.technology_1,
    tech_b_name: state.technology_2,
    archetype: state.archetype,
    status: 'generating',
  }).eq('session_id', state.sessionId);

  // Show loading
  document.getElementById('btn-generate').style.display = 'none';
  document.getElementById('cards-loading').style.display = 'block';

  try {
    // b1: Seed (silent)
    document.getElementById('loading-text').textContent = t('loading-text');
    state.seed_output = await silentAPICall('b1');
    await sb.from('sessions').update({ b1_output: state.seed_output }).eq('session_id', state.sessionId);

    // Switch to distant future screen
    await sb.from('sessions').update({ status: 'distant_future' }).eq('session_id', state.sessionId);
    showScreen('distant');

    // b2: Distant future (streamed)
    state.distant_future = await streamFromAPI('b2', 'text-distant', 'b2_output');

    // b3: Assessment (silent)
    const assessment = await silentAPICall('b3');

    // If needs revision, run b3_revision
    if (assessment.toUpperCase().includes('NEEDS REVISION')) {
      state.distant_future = await silentAPICall('b3_revision');
      await sb.from('sessions').update({ b2_output: state.distant_future }).eq('session_id', state.sessionId);
      document.getElementById('text-distant').textContent = state.distant_future;
    }

    // Show continue button
    document.getElementById('btn-to-nsd').style.display = 'block';
  } catch (error) {
    console.error('Pipeline error:', error);
    document.getElementById('cards-loading').innerHTML =
      '<p class="error-message">An error occurred. Please try again.</p>';
  }
}

async function continueToNotSoDistant() {
  document.getElementById('btn-to-nsd').style.display = 'none';
  await sb.from('sessions').update({ status: 'not_so_distant_future' }).eq('session_id', state.sessionId);
  showScreen('nsd');

  // b5: Not so distant future (streamed)
  state.not_so_distant_future = await streamFromAPI('b5', 'text-nsd', 'b5_output');
  document.getElementById('btn-to-near').style.display = 'block';
}

async function continueToNear() {
  document.getElementById('btn-to-near').style.display = 'none';
  await sb.from('sessions').update({ status: 'near_future' }).eq('session_id', state.sessionId);
  showScreen('near');

  // b6: Near future (streamed)
  state.near_future = await streamFromAPI('b6', 'text-near', 'b6_output');

  // b7: Coherence assessment (silent)
  try {
    await silentAPICall('b7');
  } catch (e) {
    console.warn('b7 assessment failed, proceeding anyway:', e);
  }

  document.getElementById('btn-to-intervention').style.display = 'block';
}

async function submitIntervention() {
  const text = document.getElementById('input-intervention').value.trim();
  if (!text) return;

  state.intervention_text = text;
  await sb.from('sessions').update({
    user_intervention: text,
    status: 'consequences',
  }).eq('session_id', state.sessionId);

  showScreen('consequences');

  // b8: Consequences (streamed)
  state.consequences = await streamFromAPI('b8', 'text-consequences', 'b8_output');
  document.getElementById('btn-to-insights').style.display = 'block';
}

async function submitInsights() {
  const text = document.getElementById('input-insights').value.trim();
  state.insights = text;

  await sb.from('sessions').update({
    user_insights: text,
    status: 'closing',
  }).eq('session_id', state.sessionId);

  // Build summary
  buildSummary();
  showScreen('closing');
}

function buildSummary() {
  const list = document.getElementById('summary-list');
  const items = [
    { label: t('summary-archetype'), value: state.archetype || '—' },
    { label: t('summary-tech'), value: [state.technology_1, state.technology_2].filter(Boolean).join(', ') || '—' },
    { label: t('summary-value'), value: state.dominant_value || '—' },
  ];

  list.innerHTML = items.map(item => `
    <div class="summary-item">
      <span class="label">${item.label}</span>
      <span class="value">${item.value}</span>
    </div>
  `).join('');
}

function startOver() {
  if (realtimeChannel) {
    sb.removeChannel(realtimeChannel);
    realtimeChannel = null;
  }

  state = {
    language: state.language,
    role: null,
    sessionId: null,
    sessionCode: null,
    archetype: null,
    resource_outlook: 'abundance',
    system_stability: 'stable',
    dominant_value: 'collectivism',
    technology_1: null,
    technology_2: null,
    selectedTechs: [],
    seed_output: '',
    distant_future: '',
    not_so_distant_future: '',
    near_future: '',
    consequences: '',
    intervention_text: '',
    insights: '',
  };

  // Reset UI
  document.querySelectorAll('.tech-card').forEach(card => {
    card.classList.remove('selected', 'disabled');
  });
  document.getElementById('slider-resource').value = 0;
  document.getElementById('slider-stability').value = 0;
  document.getElementById('slider-values').value = 0;
  updateSliderLabels();
  document.getElementById('btn-generate').disabled = true;
  document.getElementById('btn-generate').style.display = 'block';
  document.getElementById('cards-loading').style.display = 'none';
  document.getElementById('text-distant').textContent = '';
  document.getElementById('text-nsd').textContent = '';
  document.getElementById('text-near').textContent = '';
  document.getElementById('text-consequences').textContent = '';
  document.getElementById('input-intervention').value = '';
  document.getElementById('input-insights').value = '';
  document.getElementById('btn-to-nsd').style.display = 'none';
  document.getElementById('btn-to-near').style.display = 'none';
  document.getElementById('btn-to-intervention').style.display = 'none';
  document.getElementById('btn-to-insights').style.display = 'none';
  document.getElementById('cards-moderator').style.display = 'block';
  document.getElementById('cards-viewer').style.display = 'none';
  document.getElementById('summary-list').innerHTML = '';

  showScreen('welcome');
}

// ---------- INIT ----------
updateSliderLabels();
</script>
</body>
</html>
